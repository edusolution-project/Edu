@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_LayoutStudent.cshtml";
    var curentClass = ViewBag.Class as BaseCustomerEntity.Database.ClassEntity;
    ViewData["Title"] = curentClass.Name;
}

<!-- Begin Page Content -->
<div class="card-header mb-3">
    <h3 class="m-0 font-weight-bold text-primary">@curentClass.Name</h3>

    <div class="card-body">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Lịch học</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Danh sách lớp</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="contact-tab" data-toggle="tab" href="#contact" role="tab" aria-controls="contact" aria-selected="false">Thảo luận</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="tab-scores" data-toggle="tab" href="#scores" role="tab" aria-controls.="scores" aria-selected="false">Bảng điểm</a>
            </li>
        </ul>
    </div>

    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
            <div class="card card-body mt-4 mb-4">
                <div class="table-responsive">
                    <table id="scheduleTable" class="table table-bordered" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Tên bài học</th>
                                <th>Mô tả</th>
                                <th>Thời gian bắt đầu</th>
                                <th>thời gian kết thúc</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="profile" role="tabpanel">
            <div class="table-responsive">
                <div class="card shadow">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Thông tin giáo viên</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-4">
                                <img class="img-fluid" src="~/img/Luna-Blaise.jpg">
                            </div>
                            <div class="col-lg-8">
                                <h3 class="m-0 font-weight-bold text-primary">GV <span id="TeacherName"></span></h3>
                            </div>
                        </div>
                    </div>
                </div>

                <br />
                <!-- DataTales Example -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Thông tin sinh viên</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="membersTable" class="table table-bordered" width="100%" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>STT</th>
                                        <th>Họ và tên</th>
                                        <th>Lớp</th>
                                        <th>Tình trạng khóa học</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="contact" role="tabpanel">
            <div id="thao-luan" class="card shadow mb-4 mt-4">
                <div class="pl-3 pr-3 pt-3">
                    <h6 class="m-0 font-weight-bold text">Thảo luận mới</h6>
                    <hr class="line mb-0">
                </div>
                <div class="card-body">
                    <div class="item">
                        <div class="title"><span class="text font-weight-bold">Hoàng Thái Long, </span><span class="date">14/6/2019</span><span class="time">14:23:30pm</span></div>
                        <p>Phạm Anh Tuấn: vào đây xem nhé: http://educoo.vn</p>
                    </div>

                </div>
            </div>
            <div class="card shadow mb-4">
                <div class="pl-3 pr-3 pt-3">
                    <h6 class="m-0 font-weight-bold text">Thảo luận</h6>
                    <hr class="line mb-0">
                </div>
                <div class="card-body">
                    <div class="item">
                        <div class="title"><span class="text font-weight-bold">Hoàng Thái Long, </span><span class="date">14/6/2019</span><span class="time">14:23:30pm</span></div>
                        <p>Phạm Anh Tuấn: vào đây xem nhé: http://educoo.vn</p>
                    </div>
                    <div class="item">
                        <div class="title"><span class="text font-weight-bold">Phạm Anh Tuấn, </span><span class="date">14/6/2019</span><span class="time">14:23:30pm</span></div>
                        <p>Xin chào, ai có bài tập bổ trợ cho bài 1, cho mình mượn với</p>
                    </div>

                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="scores" role="tabpanel">
            <div class="card card-body mt-4 mb-4">
                <div class="table-responsive">
                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Họ và tên</th>
                                <th>Lớp</th>
                                <th>Ngày thi</th>
                                <th>Điểm thi</th>
                                <th>Trạng thái</th>
                                <th>Ngày chấm thi</th>
                                <th>Người chấm thi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><a href="#" data-toggle="modal" data-target=".bd-example-modal-lg">Phạm Anh Tuấn</a></td>
                                <td>HV001</td>
                                <td>2011/04/25</td>
                                <td>23.5</td>
                                <td>Đã hoàn thành</td>
                                <td>2011/04/25</td>
                                <td>Valerie Luna</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End of Main Content -->
@section Script{
    <script>

    var chapters = [];
    var lessons = [];
    var scheduleBody = $('#scheduleTable tbody');
    var membersBody = $('#membersTable tbody');

    function LoadSchedule() {
        chapters = [];
        lessons = [];

        $.ajax({
            type: "POST",
            url: '@Url.Action("GetSchedules", "MyCourse")',
            data: { ID: '@curentClass.ID' },
            dataType:"json",
            success: function (data) {
                scheduleCounter = 1;
                scheduleBody.html("");

                chapters = data.Data.Chapters;
                lessons = data.Data.Lessons;

                if (chapters.length > 0) {
                    for (i = 0; i < chapters.length; ++i) {
                        var chapter = chapters[i];
                        var parent = scheduleBody;

                        var chapLV = 0;
                        if (chapter.ParentID == null) {
                            chapter.ParentID = "0";
                        }

                        if (chapter.ParentID != "0")
                        {
                            parent = scheduleBody.find("tr[chapid=" + chapter.ParentID +"]");
                        }

                        var chapContent = $("<tr>", {"chapid":chapter.ID, "pid": chapter.ParentID, "clv": chapLV});
                        chapContent.append("<td colspan='6'><b>" + chapter.Name + "</b>");

                        if (chapter.ParentID === "0") {
                            scheduleBody.append(chapContent);
                        }
                        else
                        {
                            var siblings = parent.find("tr[pid=" + chapter.ParentID + "]");

                            if (siblings.length > 0) {
                                $(siblings).last().after(chapContent);
                            }
                            else
                            {
                                parent.after(chapContent);
                            }
                        }
                    }
                }


                if (lessons.length > 0) {
                    for (j = lessons.length-1; j >= 0; j--) {
                        var item = lessons[j];
                        var active = "";
                        if (item.IsActive) {
                            active = "<td><button type='button' data-toggle='button' aria-pressed='true' autocomplete='off' class='btn btn-lg btn-toggle active btn-success' disabled> <div class='handle'></div> </button></td>";
                        } else {
                            active = "<td><button type='button' data-toggle='button' aria-pressed='true' autocomplete='off' class='btn btn-lg btn-toggle btn-danger' disabled> <div class='handle'></div> </button></td>";
                        }

                        var startdate = $.datepicker.formatDate('dd/mm/yy', new Date(item.StartDate));
                        var enddate = $.datepicker.formatDate('dd/mm/yy', new Date(item.EndDate));

                        if (item.ChapterID == null) {
                            scheduleBody.append("<tr lid=\"" + item.ID + "\">" +
                            "<td><a href='@Url.Action("Detail", "LessonToday")/" + item.ID + "?ClassID=@curentClass.ID'>" + item.Title + "</td>" +
                            "<td>---</td>" +
                            "<td dvalue=\"" + item.StartDate + "\" class='startdate'><span>" + startdate + "</span></td>" +
                            "<td dvalue=\"" + item.EndDate + "\" class='enddate'><span>" + enddate + "</span></td>" + active +
                            "</tr>"
                            );
                        }
                        else
                        {
                            scheduleBody.find("tr[chapid=" + item.ChapterID + "]").after("<tr lid=\"" + item.ID + "\">" +
                            "<td><a href=" + (item.IsActive ? "'@Url.Action("Detail", "LessonToday")/" + item.ID + "?ClassID=@curentClass.ID'":"'javascript:LockNotify()'")   + ">" + item.Title + "</td>" +
                            "<td>---</td>" +
                            "<td dvalue=\"" + item.StartDate + "\" class='startdate'><span>" + startdate + "</span></td>" +
                            "<td dvalue=\"" + item.EndDate + "\" class='enddate'><span>" + enddate + "</span></td>" + active +
                            "</tr>"
                            );
                        }
                    }
                }

            },
            error: function() {
                alert("Error");
            }
        });
    }

    function LoadMembers() {
        members = [];
        $.ajax({
            type: "POST",
            url: '@Url.Action("GetMembers", "MyCourse")',
            data: {ID: "@curentClass.ID"},
            dataType:"json",
            success: function (data) {
                memberCounter = 1;
                membersBody.html("");

                teacher = data.Data.Teacher;

                $('#TeacherName').text(teacher.FullName);

                members = data.Data.Students;

                console.log(student)

                if (members.length > 0) {
                    for (j = 0; j < members.length; j++) {
                        console.log(members[j]);
                        var student = members[j];

                        var date = $.datepicker.formatDate('dd/mm/yy', new Date(student.DateBorn));
                        var lastdate = $.datepicker.formatDate('dd/mm/yy', new Date(student.LastJoinDate));

                        membersBody.append("<tr>" +
                                "<td>" + (j + 1) + "</td>" +
                                "<td>" + student.FullName + "</td>" +
                                "<td>" + (student.Class == null ?"" : student.Class[0])  + "</td>" +
                                "<td>" +
                                    "<div class=\"progress\">" +
                                        "<div class=\"progress-bar bg-success\" role=\"progressbar\" style=\"width: 0%\" aria-valuenow=\"0\" aria-valuemin=\"0\" aria-valuemax=\"100\"></div>" +
                                    "</div>" +
                                "</td>" +
                            "</tr>"
                        );
                    }
                }
            },
            error: function() {
                alert("Error");
            }
        });
    }

    function LockNotify() {
        alert("Bài học chưa được mở!");
        return false;
    }

    $(document).ready(function () {
        LoadSchedule();
        LoadMembers();
    });

    </script>
}