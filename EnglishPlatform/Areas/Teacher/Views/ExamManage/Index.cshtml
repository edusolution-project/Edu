
@{
    ViewData["Title"] = "Kho đề";
    Layout = "~/Views/Shared/_LayoutTeacher_NewUI.cshtml";

    var subjects = ViewBag.Subjects as List<BaseCustomerEntity.Database.SubjectEntity>;
    var grades = ViewBag.Grades as List<BaseCustomerEntity.Database.GradeEntity>;
    var classlist = ViewBag.ClassList as List<BaseCustomerEntity.Database.ClassEntity>;
    var currentUser = ViewBag.CurrentUser as BaseCustomerEntity.Database.TeacherEntity;
    string center = ViewContext.RouteData.Values["basis"]?.ToString();
    string processUrl(string act, string ctrl, Object param = null)
    {
        string url = Url.Action(act, ctrl, param);

        return $"/{center}{url}";
    }
}

<!-- Include vue-quill-editor -->
<script src="/libs/quill-editor/quill.min.js"></script>
<script src="/libs/quill-editor/quill-vue.min.js"></script>
<link href="/libs/quill-editor/quill.core.css" rel="stylesheet">
<link href="/libs/quill-editor/quill.snow.css" rel="stylesheet">
<link href="/libs/quill-editor/quill.bubble.css" rel="stylesheet">

<script>
    setActiveMenu("curriculum");
</script>

<section class="module" id="dashboard_content">
    @*<div class="h4 m-3" v-cloak cloak-holder>
            <i class="fas fa-sync fa-spin"></i> Đang nạp dữ liệu ...
        </div>*@
    <div class="card-header border-b">
        <div class="flex flex-row flex-wrap align-items-center">
            <div class="box filter-box w-152 m-1 ">
                <select v-model="subject">
                    <option value="">Chương trình</option>
                    <option v-for="(item,k) in list_subject" :value="item.ID">{{item.Name}}</option>
                </select>
            </div>
            <div class="box filter-box w-152 m-1">
                <select name="" v-model="grade">
                    <option value="">Cấp độ</option>
                    <option v-for="(item,k) in list_grades_full" :value="item.ID" v-if="item.SubjectID == subject">{{item.Name}}</option>
                </select>
            </div>
            <div class="search-box m-1">
                <button><i class="ic ic-find"></i></button>
                @*<input type="text" name="" v-model="searchTerm" placeholder="Tên bài giảng cần tìm">*@
            </div>
            <div class="ml-0 ml-md-auto">
                <b-button class="btn-addevent btn-sm m-1" v-on:click="showEditItem()"><i class="ti-plus"></i>Thêm mới</b-button>
                @*<b-button class="btn-addevent btn-sm m-1 ml-0 ml-md-auto" v-on:click="showEditItem()"><i class="ti-plus"></i> Thêm bài giảng</b-button>*@
            </div>
        </div>
    </div>
    <div class="card-body">
        <table id="ed_table" class="table">
            <thead>
                <tr class="text-sm-center">
                    @*<td style="width:35px"><input type="checkbox" /></td>*@
                    <td>#</td>
                    <td>Tên</td>
                    <td>Cấp độ</td>
                    <td>Chương trình</td>
                    <td>Số câu</td>
                    <td style="width:150px;max-width:150px">Tác vụ</td>
                </tr>
            </thead>
            <tbody>
                <tr v-for="(item,k) in dataResult" :id="item.ID">
                    <td>{{(page - 1) * view + (k+1)}}</td>
                    <td><a :href="'@processUrl("StorageQuestion","ExamManage")/' + item.ID">{{item.Name}}</a></td>
                    <td>{{item.GradeName}}</td>
                    <td>{{item.SubjectName}}</td>
                    <td>{{item.TotalQuestion}}</td>
                    <td>
                        <div class="btn-group" style="display:block">
                            <a class="btn-act btn-edit" title="Sửa" href="javascript:;" v-on:click="showEditItem(item)"><i class="fas fa-edit"></i></a>
                            <a class="btn-act btn-edit" title="Tạo bài kiểm tra" href="javascript:;" v-on:click="showCreateExam(item.ID)"><i class="fas fa-pen-fancy"></i></a>
                            <button class="btn-act btn-trash" title="Xóa" v-on:click="removeItem(item)"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="box margin-t20 flex">
            <div class="paging-view">
                Hiển thị:
                <select v-model="view" v-on:change="getData()">
                    <option value="10">10 kết quả</option>
                    <option value="20">20 kết quả</option>
                    <option value="30">30 kết quả</option>
                </select>
            </div>
            <div class="page-control">
                <div class="right">
                    <b-pagination v-model="page"
                                  :total-rows="totalRec"
                                  :per-page="view"
                                  v-on:input="getData()"></b-pagination>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts{
    <script>
        new Vue({
            el: "#main_content",
            mounted() {
                this.list_subject = @Html.Raw(Json.Serialize(subjects));
                this.list_grades_full = @Html.Raw(Json.Serialize(grades));
                this.currentUser = @Html.Raw(Json.Serialize(currentUser));
                this.list_classes = @Html.Raw(Json.Serialize(classlist));
                this.getData();
                @*this.list_skills = @Html.Raw(Json.Serialize(skills));
                this.list_courses = @Html.Raw(Json.Serialize(courses));*@
            },
            components: {},
            data: {
                isLoading: false,
                currentUser:[],
                list_subject: [],
                list_grades_full:[],
                addItem: {
                    ID: '',
                    Name: '',
                    SubjectID: '',
                    GradeID: '',
                    Description: '',
                    CreateUser: ''
                },
                editorOption: {
                    theme: 'snow'
                },
                list_classes: [],
                subject: '',
                grade: '',
                view: 30,
                page: 1,
                totalRec: 0,
                searchTerm: '',
                dataResult: [],
                createExam: {
                    startTime: '',
                    endTime: '',
                    totalEasy: 0,
                    totalNormal: 0,
                    totalHard: 0,
                    totalQuestion:0,
                    classID: [],
                    name: '',
                    countQuestion: '',
                    timer: '', //
                    limit: '',
                    etype: 0, // mặc định là hệ số 1
                    multiple: '',
                    nameClass: '',
                    targetClasses: [],
                    displaySelect: false,
                    selectAll: false,
                    totalExam: 1, //số đề, ít nhất là 1
                    examQuestionArchiveID: '',// ma kho de
                    title:''
                },
                formatExam: {
                    titleFormat: '',
                    titleExam: '',
                    timer: 1,
                    limit: 1,
                    typeExam: '@BaseCustomerEntity.Database.CLASSSUBJECT_TYPE.EXAM',
                    totalExam: 1,
                    format: {
                        level: '',
                        tag: '',
                        levelKnow: 0, //nhận biết
                        levelUnderstanding: 0, //thông hiểu
                        levelManipulate:0, //vận dụng
                        levelManipulateHighly: 0, //vận dụng cao
                        total: 0
                    }
                },
                list_Tags:[]
            },
            computed: {},
            watch: {
            },
            methods: {
                getData() {
                    let _that = this
                    let _form = new FormData
                    _form.append('GradeID', _that.grade)
                    _form.append('SubjectID', _that.subject)
                    _form.append('PageSize', _that.view)
                    _form.append('PageIndex', _that.page)
                    _form.append('SearchText', _that.searchTerm)
                    let _url = '@processUrl("GetList", "ExamManage")'
                    axios.post(_url, _form)
                        .then(response => {
                            //debugger
                            var data = response.data.Data
                            var model = response.data.Model
                            _that.dataResult = data
                            this.dataResult = _that.dataResult
                        }).catch(e => {
                            alert(e)
                        })
                },
                showEditItem(item) {
                    let _that = this
                    this.addItem.CreateUser = this.currentUser.ID
                    this.addItem.displaySelect = false
                    this.addItem.SelectAll = false
                    if (!item) {
                        this.addItem.Name = ""
                        this.addItem.SubjectID = ""
                        this.addItem.GradeID = ""
                        this.addItem.Description = ""
                        this.addItem.NameClass = ""
                        this.addItem.TargetClasses = []
                    }
                    else {

                    }
                    _that.$bvModal.show('modal_event')
                },
                showCreateExam(itemID,item) {
                    let _that = this
                    this.getOptionFormatExam(itemID)
                    if (item == undefined) {
                        _that.formatExam = {
                            titleFormat: '',
                            titleExam: '',
                            timer: 1,
                            limit: 1,
                            typeExam: '@BaseCustomerEntity.Database.CLASSSUBJECT_TYPE.EXAM',
                            totalExam: 1,
                            format:[
                            {
                                level: '',
                                tag: '',
                                levelKnow: 0, //nhận biết
                                levelUnderstanding: 0, //thông hiểu
                                levelManipulate: 0, //vận dụng
                                levelManipulateHighly: 0, //vận dụng cao
                                total: 0
                                }
                            ]
                        }
                    }
                    _that.$bvModal.show('create-exam-modal-xl')
                },
                saveItem() {
                    let _that = this
                    let _form = new FormData()
                    let _url = '@processUrl("CreateOrUpdate","ExamManage")'
                    _form.append("Name", _that.addItem.Name)
                    _form.append("SubjectID", _that.addItem.SubjectID)
                    _form.append("GradeID", _that.addItem.GradeID)
                    _form.append("Description", _that.addItem.Description)
                    //debugger
                    //for (var i = 0; i < _that.addItem.TargetClasses.length; i++) {
                    //    var item = _that.addItem.TargetClasses[i]
                    //    _form.append("TargetClasses", item)
                    //}
                    axios.post(_url, _form)
                        .then(response => {
                            var item = response.data.Data
                            var filter = this.dataResult.find(x => x.ID == item.ID)
                            if (filter == null) {
                                var array = []
                                array.push(item)
                                //array.concat(this.dataResult)
                                for (var i = 0; i < this.dataResult.length; i++) {
                                    array.push(this.dataResult[i])
                                }
                                this.dataResult = array
                            }
                            _that.isLoading = false

                        }).catch(e => {
                            _that.isLoading = false;
                            alert("Error: " + e)
                        })
                    _that.hideModal();
                },
                checkToggleAll() {
                    if (this.createExam.selectAll) {
                        var _that = this
                        _that.createExam.targetClasses = []
                        if (_that.createExam.selectAll) {
                            _that.list_classes.forEach(function (item, pos) {
                                _that.createExam.targetClasses.push(item.ID)
                                _that.createExam.nameClass += item.Name + ", "
                            })
                        }
                    }
                    else {
                        this.createExam.nameClass = ""
                        this.createExam.targetClasses = []
                    }
                },
                checkToggle() {
                    this.createExam.selectAll = (this.createExam.targetClasses.length == this.list_classes.length)
                    this.createExam.nameClass = ''
                    for (i = 0; i < this.list_classes.length; i++) {
                        for (j = 0; j < this.createExam.targetClasses.length; j++) {
                            if (this.list_classes[i].ID == this.createExam.targetClasses[j]) {
                                this.createExam.nameClass += this.list_classes[i].Name + '; '
                            }
                        }
                    }
                },
                toggleSelect() {
                    this.createExam.displaySelect = !this.createExam.displaySelect
                },
                hideModal() {
                    $('.close').click();
                },
                removeItem(item) {
                    if (window.confirm("Thầy/Cô @Html.Raw(currentUser == null ? "" : currentUser.FullName) xác nhận muốn xoá " + item.Name + "?")) {
                        let _that = this
                        let _form = new FormData
                        _form.append("IDs", item.ID)
                        let _url = '@processUrl("DeleteExamQuestionArchive", "ExamManage")'
                        axios.post(_url, _form)
                            .then(response => {
                                var data = response.data.IDs
                                if (data.length > 0) {
                                    for (var i = 0; i < data.length; i++) {
                                        var item = data[i]
                                        $("#" + item).remove()
                                    }
                                }
                                else {
                                    alert(response.data.Msg)
                                }
                            }).catch(e => {
                                alert(e)
                            })
                    }
                },
                showCoefficient() {
                    var typeExam = this.createExam.etype;
                    if (typeExam == '@BaseCustomerEntity.Database.LESSON_ETYPE.PRACTICE') {
                        this.createExam.multiple = '1'
                    }
                    else if (typeExam == '@BaseCustomerEntity.Database.LESSON_ETYPE.WEEKLY') {
                        this.createExam.multiple = '2';
                    }
                    else if (typeExam == '@BaseCustomerEntity.Database.LESSON_ETYPE.CHECKPOINT') {
                        this.createExam.multiple = '3';
                    }
                    else {
                        return false;
                    }
                },

                //
                createNewExam(isNew) {
                    let _that = this
                    let _form = new FormData()
                    let _url = '@processUrl("CreateOrUpdateExam", "ExamManage")'
                    _form.append("ExamQuestionArchiveID", _that.createExam.examQuestionArchiveID)
                    _form.append("ExamQuestionArchiveID", _that.formatExam.titleFormat)
                    _form.append("ExamQuestionArchiveID", _that.formatExam.titleExam)
                    _form.append("ExamQuestionArchiveID", _that.formatExam.timer)
                    _form.append("ExamQuestionArchiveID", _that.formatExam.limit)
                    _form.append("ExamQuestionArchiveID", _that.formatExam.typeExam)
                    _form.append("ExamQuestionArchiveID", _that.formatExam.totalExam)
                    
                    axios.post(_url, _form)
                        .then(response =>
                        {
                        })
                        .catch(e => { alert(e) })
                },
                addTdFormatExam(obj) {
                    //if (obj.length > 0) {
                    var currentFormatExam = this.formatExam.format
                    var template = {
                        level: '',
                        tag: '',
                        levelKnow: 0, //nhận biết
                        levelUnderstanding: 0, //thông hiểu
                        levelManipulate: 0, //vận dụng
                        levelManipulateHighly: 0, //vận dụng cao
                        total: 0
                    }
                    currentFormatExam.push(template)
                    //}
                },
                getOptionFormatExam(id) {
                    let _that = this
                    let _form = new FormData()
                    let _url = '@processUrl("GetOptionFormatExam", "ExamManage")'
                    _form.append("ID", id)
                    axios.post(_url, _form)
                        .then(response => {
                            var stt = response.data.Status
                            if (stt) {
                                var data = response.data.Data
                                this.list_Tags = data
                            }
                            else {
                                alert(response.data.Msg)
                            }
                        })
                        .catch(e => {
                            alert(e)
                        })
                },
                removeOption(k) {
                    this.formatExam.format.splice(k, 1);
                },
                refreshOption(k) {
                    var option = this.formatExam.format[k]
                    option.level = ''
                    option.levelKnow = 0
                    option.levelUnderstanding = 0
                    option.levelManipulate = 0
                    option.levelManipulateHighly = 0
                    option.tag = ''
                }
            }
        });
    </script>
    <style>
        #ed_table tr th:first-child,
        #ed_table tr td:first-child {
            width: 30px;
            max-width: 30px;
        }
    </style>
}

@section Modals{
    <b-modal id="modal_event" centered title="Kho đề thi" size="xl">
        <b-col class="form-group d-none">
            <input type="text" id="examQuestionArchiveID" v-model="createExam.examQuestionArchiveID" class="hide" disabled />
        </b-col>
        <b-col class="form-group">
            <label for="">Tên kho đề</label>
            <input type="text" name="" value="" class="form-control" placeholder="Tên bài giảng" v-model="addItem.Name">
        </b-col>
        <div class="d-flex">
            <b-col class="form-group">
                <label for="">Chương trình</label>
                <select class="form-control" v-model="addItem.SubjectID">
                    <option value="">Chọn chương trình</option>
                    <option v-for="(item,k) in list_subject" :value="item.ID">{{item.Name}}</option>
                </select>
            </b-col>
            <b-col class="form-group">
                <label for="">Cấp độ</label>
                <select class="form-control" v-model="addItem.GradeID">
                    <option value="">Chọn cấp độ</option>
                    <option v-for="(item,k) in list_grades_full" :value="item.ID" v-if="item.SubjectID == addItem.SubjectID">{{item.Name}}</option>
                </select>
            </b-col>
        </div>
        <div>
            <b-col class="form-group">
                <label for="">Giáo viên soạn thảo</label>
                <select class="form-control" v-model="addItem.CreateUser" style="z-index:1" disabled>
                    <option :value="currentUser.ID">{{currentUser.FullName}}</option>
                </select>
            </b-col>
        </div>

        @*<b-col class="form-group">
                <label for="">Mô tả</label>
                <quill-editor v-model="addItem.Description"
                              ref="quillEditorA"
                              :options="editorOption">
                </quill-editor>
            </b-col>*@
        <template v-slot:modal-footer="{ ok, cancel}">
            <template v-if="isLoading">
                <b-button>Đang thực hiện...</b-button>
            </template>
            <template v-else>
                <b-button variant="success" v-on:click="saveItem()">Lưu</b-button>
                <b-button variant="danger" v-on:click="hideModal()">Huỷ</b-button>
            </template>
        </template>
    </b-modal>

    <b-modal id="create-exam-modal-xl" size="xl" title="Tạo kỳ kiểm tra">
        <b-col>
            <div class="row">
                <div class="col-md-6">
                    <label class="label">Tên ma trận đề</label>
                    <input type="text" class="form-control" placeholder="Tên ma trận đề" v-model="formatExam.titleFormat"/>
                </div>
                <div class="col-md-6">
                    <label class="label">Tiêu đề</label>
                    <input type="text" class="form-control" placeholder="Tên đề" v-model="formatExam.titleExam"/>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <label class="label">Thời gian làm bài</label>
                    <input type="number" min="1" class="form-control" v-model="formatExam.timer" />
                </div>
                <div class="col-md-6">
                    <label class="label">Lượt làm</label>
                    <input type="number" min="1" class="form-control" v-model="formatExam.limit"/>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <label class="label">Loại đề</label>
                    <select class="form-control" v-model="formatExam.typeExam">
                        <option value="@BaseCustomerEntity.Database.CLASSSUBJECT_TYPE.EXAM">Kiểm tra</option>
                        <option value="@BaseCustomerEntity.Database.CLASSSUBJECT_TYPE.STANDARD">Luyện tập</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="label">Số đề</label>
                    <template v-if="formatExam.typeExam == '@BaseCustomerEntity.Database.CLASSSUBJECT_TYPE.EXAM'">
                        <input type="number" min="1" class="form-control" v-model="formatExam.totalExam"/>
                    </template>
                    <template v-else>
                        <input type="number" min="1" class="form-control" placeholder="Không giới hạn" disabled readonly/>
                    </template>
                </div>
            </div>

            <div class="row mt-3">
                <label class="label">Cấu trúc</label>
                <table class="table table-bordered table-sm">
                    <thead>
                        <tr>
                            <td rowspan="2" class="text-center align-middle">STT</td>
                            <td rowspan="2" style="width:150px;text-align:center;vertical-align:middle">Khối</td>
                            <td rowspan="2" style="width:150px;text-align:center;vertical-align:middle">Chuyên đề | Nội dung</td>
                            <td colspan="4" style="text-align:center">Mức độ</td>
                            <td rowspan="2" class="text-center align-middle" style="width:100px">Số câu</td>
                            <td rowspan="2" class="text-center align-middle" style="width:100px">Tác vụ</td>
                        </tr>
                        <tr>
                            <td class="text-center align-middle">Nhận biết</td>
                            <td class="text-center align-middle">Thông hiểu</td>
                            <td class="text-center align-middle">Vận dụng</td>
                            <td class="text-center align-middle">Vận dụng cao</td>
                        </tr>
                    </thead>

                    <tbody>
                        <tr v-for="(item,k) in formatExam.format" :id="'formatExam_' + k">
                            <td class="text-center align-middle">{{k+1}}</td>
                            <td>
                                <select class="form-control" v-model="item.tag">
                                    <option></option>
                                </select>
                            </td>
                            <td>
                                @*<input type="text" class="form-control" v-model="item.tag"/>*@
                                <select class="form-control" v-model="item.tag">
                                    <option value="">Chọn nội dung</option>
                                    <option v-for="(_tag,i) in list_Tags" :value="_tag.Code">{{_tag.Name}}</option>
                                </select>
                            </td>
                            <td>
                                <input type="number" min="0" class="form-control" v-model="item.levelKnow"/>
                            </td>
                            <td>
                                <input type="number" min="0" class="form-control" v-model="item.levelUnderstanding"/>
                            </td>
                            <td>
                                <input type="number" min="0" class="form-control" v-model="item.levelManipulate"/>
                            </td>
                            <td>
                                <input type="number" min="0" class="form-control" v-model="item.levelManipulateHighly"/>
                            </td>
                            <td>
                                <input type="number" min="0" class="form-control" v-model="item.levelKnow + item.levelUnderstanding + item.levelManipulate + item.levelManipulateHighly" disabled readonly/>
                            </td>
                            <td class="text-center align-middle">
                                <button title="Xoá điều kiện" v-on:click="removeOption(k)" class="btn-act"><i class="ti-trash"></i></button>
                                <button title="Đặt lại" v-on:click="refreshOption(k)" class="btn-act"><i class="ti-reload"></i></button>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="9" class="text-right">
                                <a class="btn-add-sub" title="Thêm điều kiện" href="javascript:;" v-on:click="addTdFormatExam(formatExam.format)"><i class="ic ic-plus-c"></i>Thêm điều kiện</a>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2" class="text-center align-middle">Tổng</td>
                            <td>
                                <input type="number" class="form-control" disabled readonly />
                            </td>
                            <td>
                                <input type="number" class="form-control" disabled readonly />
                            </td>
                            <td>
                                <input type="number" class="form-control" disabled readonly />
                            </td>
                            <td>
                                <input type="number" class="form-control" disabled readonly />
                            </td>
                            <td>
                                <input type="number" class="form-control" disabled readonly />
                            </td>
                            <td>
                                <input type="number" class="form-control" disabled readonly />
                            </td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </b-col>
        <template v-slot:modal-footer="{ ok, cancel}">
            <template v-if="isLoading">
                <b-button>Đang thực hiện...</b-button>
            </template>
            <template v-else>
                <b-button variant="primary" v-on:click="createNewExam(true)">Tạo mới</b-button>
                <b-button variant="success" v-on:click="createNewExam(false)">Lưu</b-button>
                <b-button variant="danger" v-on:click="hideModal()">Huỷ</b-button>
            </template>
        </template>
    </b-modal>
}
