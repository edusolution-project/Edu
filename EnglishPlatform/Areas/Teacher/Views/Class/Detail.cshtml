@{

    Layout = "~/Views/Shared/_LayoutTeacher_NewUI.cshtml";
    var currentClass = ViewBag.Class as BaseCustomerMVC.Models.ClassViewModel;
    ViewData["Title"] = currentClass.Name;
    var currentuser = User.Claims.Single(t => t.Type == "UserID").Value;
    string center = ViewContext.RouteData.Values["basis"]?.ToString();
    var listsubjects = ViewBag.Subjects as List<BaseCustomerEntity.Database.SubjectEntity>;
    var listgrades = ViewBag.Grades as List<BaseCustomerEntity.Database.GradeEntity>;
    string processUrl(string act, string ctrl, Object param = null)
    {
        string url = Url.Action(act, ctrl, param);

        return $"/{center}{url}";
    }
}


@*<script src="/libs/vuejs-datepicker.min.js"></script>*@
<script src="~/js/bootstrap-vue.min.js"></script>
<link href="~/js/lib/datetimepicker/jq.datetimepicker.css" rel="stylesheet" />
<script src="~/js/lib/datetimepicker/php-date-formatter.min.js"></script>
<script src="~/js/lib/datetimepicker/jquery.mousewheel.js"></script>
<script src="~/js/jquery-ui.min.js"></script>
<link href="~/css/jquery-ui.min.css" rel="stylesheet" />
<script src="~/js/lib/datetimepicker/jquery.datetimepicker.js"></script>

<script src="/libs/quill-editor/quill.min.js"></script>
<script src="/libs/quill-editor/quill-vue.min.js"></script>
<link href="/libs/quill-editor/quill.core.css" rel="stylesheet">
<link href="/libs/quill-editor/quill.snow.css" rel="stylesheet">
<link href="/libs/quill-editor/quill.bubble.css" rel="stylesheet">

<script>
    setActiveMenu("course");
</script>
<section class="module" id="dashboard_content">
    <div class="card-header" v-cloak>
        <div class="flex mb-2">
            <h2 class="title"><a href="@processUrl("Detail", "Class")" title="{{domDecoder(className)}}"><i class="ti-arrow-left d-none"></i></a>{{domDecoder(className)}}</h2>
        </div>
        <div class="flex j-between border-b">
            <div class="tab bg-none">
                <ul class="flex flex-row">
                    <li v-bind:class="{active : tab[0]}"><a href="javascript:;" title="Tổng quan" v-on:click="tabChange()">Tổng quan</a></li>
                    <li v-bind:class="{active : tab[1]}"><a href="javascript:;" title="Môn học" v-on:click="tabChange(1)">Tạo lịch dạy</a></li>
                    <li v-bind:class="{active : tab[2]}"><a href="javascript:;" title="Học viên" v-on:click="tabChange(2)">Bảng điểm</a></li>
                    <li v-bind:class="{active : tab[3]}"><a href="javascript:;" title="Tài liệu tham khảo" v-on:click="tabChange(3)">Tài liệu tham khảo</a></li>
                    <li v-bind:class="{active : tab[4]}"><a href="javascript:;" title="Tiến độ học tập" v-on:click="tabChange(4)">Tiến độ học tập</a></li>
                </ul>
            </div>
            <div class="c-right">
                <b-button class="btn-addevent" v-on:click="showRefModal()" v-if="tab[3]"><i class="ti-plus"></i></b-button>
            </div>
        </div>
        <div class="d-flex align-items-center" v-if="tab[2]">
            <div class="box filter-box m-1">
                <select v-model="searchCsbj">
                    <option value="">Tổng hợp</option>
                    <option v-for="(item,k) in classSubjects" :value="item.ID">{{item.CourseName}}</option>
                </select>
            </div>
            <div class="m-1 position-relative" v-if="searchCsbj != ''">
                <button type="button" tabindex="-1" data-toggle="dropdown" class="btn btn-default dropdown-toggle" v-on:click="toggleSelect()" style="border:1px solid #D0DFE8">
                    Xem điểm theo tuần <span class="caret"></span>
                </button>
                <div style="position:absolute;left:0;top:40px;z-index:2" v-if="displaySelect">
                    <div id="selectCenters">
                        <ul class="chapSelect" role="menu" style="overflow-y:auto; min-width: 200px; list-style:none; padding: 7px; border: solid 1px #CCC; background: #FFF;">
                            <li>
                                <input type="checkbox" v-model="filterChap.SelectAll" v-on:change="checkToggleAll()" /><span class="lbl"> Tất cả chương </span>
                            </li>
                            <li v-for="(item,k) in scoreSbjChap" class="d-flex flex-row align-items-center">
                                <input type="checkbox" :value="item.ID" v-model="filterChap.TargetChaps" v-on:change="checkToggle()" /><span class="ml-1 lbl"> {{item.Name}} </span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="h4 m-3" v-cloak cloak-holder>
        <i class="fas fa-sync fa-spin"></i> Đang nạp dữ liệu ...
    </div>
    <div class="card-body" v-cloak>
        <div class="box" v-if="tab[0]">
            <ul class="box list ls-overview mb-3">
                <li class="flex margin-b20">
                    <a href="#" class="thumb"><img :src="cacheStatic(classImg,256)" alt="" /></a>
                    <div class="c-right">
                        <p><span class="label">Tên lớp: </span>{{domDecoder(className)}}</p>
                        <p><span class="label">Chương trình: </span>{{domDecoder(subjectName)}}</p>
                        <p><span class="label">Môn học: </span>{{skillName}}</p>
                        <ul class="time-line flex">
                            <li><i class="ti-time"></i>Bắt đầu: {{formatShortDate(startDate)}} </li>
                            <li><i class="ti-time"></i>Kết thúc: {{formatShortDate(endDate)}} </li>
                        </ul>
                    </div>
                </li>
            </ul>
            <div class="box info-practice">
                <h4>Chi tiết lớp học</h4>
                <p v-html="replaceBrkLine(domDecoder(classDescription))"></p>
            </div>
        </div>
        <div class="box" v-show="tab[1]">
            <div class="form-group">
                <h3 style="font-size:15px;" class="font-weight-bold">Học liệu chính quy</h3>
                <ul class="list ls-practice">
                    <li v-for="(obj,i) in classSubjects" v-if="obj.TypeClass == @BaseCustomerEntity.Database.CLASS_TYPE.STANDARD" :for="obj.ID">
                        <div class="class_row d-flex justify-content-start" >
                            <a href="javascript:;" v-b-toggle="`collapse-${i}`" class="btn-collapse parent flex-row align-items-center pb-2 mb-0 pt-2" v-on:click="loadContent(obj.ID)" :style="'color: ' + obj.Color">
                                <i class="ic ic-headphone-o mr-1" :style="'background-image:url(' + cacheStatic(obj.Image,48) + ')'"></i>{{obj.Title + ' (' + obj.CourseName + ' - GV: ' + obj.Teacher + ')'}}
                                <i class="far fa-arrow-alt-circle-down ml-1"></i>
                            </a>
                            <a href="javascript:;" class="font-weight-bolder pb-2 mb-0 pt-2 text-dark" v-on:click="showScoreboard(obj)">
                                <i class="fas fa-poll-h ml-3"></i>
                                Bảng điểm
                            </a>
                            <a href="javascript:;" class="font-weight-bolder pb-2 mb-0 pt-2 text-dark d-none" v-on:click="showEditor(obj)">
                                <i class="far fa-edit ml-3"></i>
                                Chuyển chế độ soạn thảo
                            </a>
                        </div>
                        <b-collapse :id="`collapse-${i}`" accordion="my-accordion-0" role="tabpanel">
                            <ul class="list">
                                <chap-content v-for="(item,k) in list_chapters" v-if="item.ClassSubject + '-' + item.Parent == obj.ID + '-'"
                                              v-bind:data="item"
                                              v-bind:classbj="obj.ID"
                                              v-bind:pos="k"
                                              v-bind:owner="obj.TeacherID"
                                              v-bind:listchaps="list_chapters"></chap-content>
                                <lesson-item v-for="lesson in filterLesson({ID:'0', ClassSubject: obj.ID})" v-bind:data="lesson" v-bind:owner="obj.TeacherID" v-bind:classSubject="obj.ID"></lesson-item>
                            </ul>
                        </b-collapse>
                    </li>
                </ul>
            </div>
            <div class="form-group">
                <h3 style="font-size:15px;" class="font-weight-bold pt-3">Học liệu chuyên đề</h3>
                <ul class="list ls-practice">
                    <li v-for="(obj,i) in classSubjects" v-if="obj.TypeClass == @BaseCustomerEntity.Database.CLASS_TYPE.EXTEND" :for="obj.ID">
                        <div class="class_row d-flex justify-content-start">
                            <a href="javascript:;" v-b-toggle="`collapse-${i}`" class="btn-collapse parent flex-row align-items-center pb-2 mb-0 pt-2" v-on:click="loadContent(obj.ID)" :style="'color: ' + obj.Color">
                                <i class="ic ic-headphone-o mr-1" :style="'background-image:url(' + cacheStatic(obj.Image,48) + ')'"></i>{{obj.Title + ' (' + obj.CourseName + ' - GV: ' + obj.Teacher + ')'}}
                                <i class="far fa-arrow-alt-circle-down ml-1"></i>
                            </a>
                            <a href="javascript:;" class="font-weight-bolder pb-2 mb-0 pt-2 text-dark" v-on:click="showScoreboard(obj)">
                                <i class="fas fa-poll-h ml-3"></i>
                                Bảng điểm
                            </a>
                            <a href="javascript:;" class="font-weight-bolder pb-2 mb-0 pt-2 text-dark d-none" v-on:click="showEditor(obj)">
                                <i class="far fa-edit ml-3"></i>
                                Chuyển chế độ soạn thảo
                            </a>
                        </div>
                        <b-collapse :id="`collapse-${i}`" accordion="my-accordion-0" role="tabpanel">
                            <ul class="list">
                                <chap-content v-for="(item,k) in list_chapters" v-if="item.ClassSubject + '-' + item.Parent == obj.ID + '-'"
                                              v-bind:data="item"
                                              v-bind:classbj="obj.ID"
                                              v-bind:pos="k"
                                              v-bind:owner="obj.TeacherID"
                                              v-bind:listchaps="list_chapters"></chap-content>
                                <lesson-item v-for="lesson in filterLesson({ID:'0', ClassSubject: obj.ID})" v-bind:data="lesson" v-bind:owner="obj.TeacherID" v-bind:classSubject="obj.ID"></lesson-item>
                            </ul>
                        </b-collapse>
                    </li>
                </ul>
            </div>
        </div>
        <div class="box" v-if="tab[2]">
            <table id="ed_table" class="table table-hover" v-if="searchCsbj == ''">
                <thead>
                    <tr>
                        <th rowspan="2">#</th>
                        <th rowspan="2">Họ tên</th>
                        <th rowspan="2">Tiến độ</th>
                        <th rowspan="2">Lần học cuối</th>
                        <th colspan="3">Luyện tập</th>
                        <th colspan="3">Kiểm tra</th>
                        <th rowspan="2">Xếp hạng</th>
                    </tr>
                    <tr>
                        <th>Thực hiện</th>
                        <th>TB</th>
                        <th>TK</th>
                        <th>Thực hiện</th>
                        <th>TB</th>
                        <th>TK</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(item,k) in scoreData">
                        <td>{{(k+1)}}</td>
                        <td><a :href="'@processUrl("StudentDetail", "Class")/' + item.StudentID + '/@currentClass.ID'" :title="item.FullName">{{item.FullName}}</a></td>
                        <td class="text-danger" v-bind:class="{good : (getPercent(item.Completed, item.TotalLessons) > 50)}"> {{getPercent(item.Completed, item.TotalLessons).toFixed(2)}}%  ({{item.Completed}}/{{item.TotalLessons}})</td>
                        <td>{{formatTime(item.LastDate)}}</td>
                        <td class="text-black">{{item.PracticeDone}}/{{item.TotalPractices}}</td>
                        <td class="text-danger" v-bind:class="{good : (item.PracticeAvgPoint > 50)}">{{item.PracticeAvgPoint > 0 ?  item.PracticeAvgPoint.toFixed(2) : '0.00'}}%</td>
                        <td class="text-danger" v-bind:class="{good : (item.PracticeResult > 50)}">{{item.PracticeResult > 0 ?  item.PracticeResult.toFixed(2) : '0.00'}}%</td>
                        <td class="text-black">{{item.ExamDone}}/{{item.TotalExams}}</td>
                        <td class="text-danger" v-bind:class="{good : (item.AvgPoint > 50)}">{{item.AvgPoint > 0 ? item.AvgPoint.toFixed(2) : '0.00'}}%</td>
                        <td class="text-danger" v-bind:class="{good : (item.ExamResult > 50)}">{{item.ExamResult > 0 ?  item.ExamResult.toFixed(2) : '0.00'}}%</td>
                        <td class="text-black" v-bind:class="{good : (item.Rank > 0 && item.Rank < 4)}">{{item.Rank > 0 ? (item.Rank + '/' + item.TotalStudents)  : '---'}}</td>
                    </tr>
                </tbody>
            </table>
            <div class="w-100 overflow-auto" v-else>
                <table class="table table-hover" id="ed_table" v-if="filterChap.TargetChaps.length > 0" style="table-layout: fixed">
                    <thead>
                        <tr>
                            <th style="max-width:50px; width: 50px;">#</th>
                            <th style="max-width:200px; width: 200px;">Họ tên</th>
                            <th v-for="(item,k) in scoreSbjChap" class="sbjScoreCol" v-if="filterChap.TargetChaps.indexOf(item.ID) !== -1">
                                {{item.Name}}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(student,i) in scoreSbjStudent">
                            <td>{{(i+1)}}</td>
                            <td><a :href="'@processUrl("StudentDetail", "Class")/' + student.ID + '/@currentClass.ID'" :title="student.FullName">{{student.FullName}}</a></td>
                            <td v-for="(result,k) in scoreSbjChap" class="sbjScoreCol text-danger" v-if="filterChap.TargetChaps.indexOf(result.ID) !== -1" v-bind:class="{good : (getAvgTotal(k, student.ID) > 50)}">{{getSbjScoreText(k, student.ID)}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="box" v-if="tab[3]">
            <div class="row ls-doc" v-if="ref.data.length > 0">
                <div class="col-md-6" v-for="data in ref.data">
                    <div class="flex p-2 mb-2 inner" style="border-top: dotted 1px #DDD">
                        <a href="#" title="" class="thumb" style="max-width:130px; min-width:130px;" v-on:click="showPreview(data)">
                            <img :src="cacheStatic(data.Image,130)" alt="" v-if="data.Image != null" class="w-100">
                            <img :src="cacheStatic('/pictures/book.jpg',130)" alt="" v-else class="w-100">
                        </a>
                        <div class="entry p-0">
                            <div>
                                <div>
                                    <a href="#" title="" class="title" v-on:click="showPreview(data)">{{data.Title}}</a>
                                </div>
                                @*<div>
                                        <div class="rating"><i class="icofont icofont-star"></i><i class="icofont icofont-star"></i><i class="icofont icofont-star"></i><i class="icofont icofont-star"></i><i class="icofont icofont-star"></i></div>
                                        <div class="author pt-2"><i class="icofont icofont-teacher"></i> {{data.OwnerName}}</div>
                                    </div>*@
                            </div>
                            <div class="pt-0 pb-2">
                                <p>{{domDecoder(data.Description)}}</p>
                            </div>
                            <div>
                                <a href="#" title="Mở link" class="text-success font-weight-bold mr-2" style="min-width:auto" v-on:click="openLink(data)" v-if="data.Link != null && data.Link.length > 0"><i class="fas fa-link"></i> ({{data.Linked}})</a>
                                <a href="#" title="Mở file" class="text-success font-weight-bold mr-2" style="min-width:auto" v-on:click="showPreview(data)" v-if="data.Media!= null && isDocType(data.Media.Extension)"><i class="far fa-eye font-weight-bold"></i> ({{data.Viewed}})</a>
                                <a href="#" class="text-success font-weight-bold mr-2" v-if="data.Media != null && data.isDownload" v-on:click="download(data)" :title="data.Media.Name"><i class="fas fa-cloud-download-alt"></i> ({{data.Downloaded}})</a>
                                <a href="#" title="Xóa" class="text-danger mr-2" v-on:click="deleteData(data)" v-if="data.OwnerID == '@currentuser'"><i class="far fa-trash-alt font-weight-bold"></i></a>
                                <a href="#" title="Sửa" class="text-secondary mr-2" v-on:click="updateRef(data)" v-if="data.OwnerID == '@currentuser'"><i class="fas fa-edit font-weight-bold"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row ls-doc text-center d-block" v-else>
                Không có tài liệu
            </div>
        </div>
        <div class="box margin-t20 flex" v-if="tab[3] && ref.data.length > 0">
            <div class="paging-view">
                Hiển thị:
                <select v-model="ref.view" v-on:change="loadPreference()">
                    <option value="10">10 kết quả</option>
                    <option value="20">20 kết quả</option>
                    <option value="30">30 kết quả</option>
                </select>
            </div>
            <div class="page-control">
                <div class="right">
                    <b-pagination v-model="ref.page"
                                  :total-rows="ref.totalRec"
                                  :per-page="ref.view"
                                  v-on:input="loadPreference()"></b-pagination>
                </div>
            </div>
        </div>
        <div class="box" v-show="tab[4]">
            <ul class="list ls-practice">
                <li v-for="(obj,i) in classSubjects">
                    <div class="inner">
                        <a href="javascript:;" v-b-toggle="`collapse-result-${i}`" class="btn-collapse parent flex align-items-center pb-2 mb-0 pt-2 collapsed" v-on:click="loadResult(obj.ID)" :style="'color: ' + obj.Color">
                            <i class="ic ic-headphone-o mr-1" :style="'background-image:url(' + cacheStatic(obj.Image,48) + ')'"></i>{{obj.Title + ' (' + obj.CourseName + ' - GV: ' + obj.Teacher + ')'}}
                            <i class="far fa-arrow-alt-circle-down ml-1"></i>
                        </a>
                        <b-collapse :id="`collapse-result-${i}`" accordion="my-accordion-1" role="tabpanel">
                            <ul class="list">
                                <chap-result v-for="(item,k) in list_chapters_result" v-if="item.ClassSubject + '-' + item.Parent == obj.ID + '-'"
                                             v-bind:data="item"
                                             v-bind:classbj="obj.ID"
                                             v-bind:pos="k"
                                             v-bind:owner="obj.TeacherID"
                                             v-bind:listchaps="list_chapters_result"></chap-result>
                                <lesson-result v-for="lesson in filterResult({ID:'0', ClassSubject: obj.ID})" v-bind:data="lesson" v-bind:owner="obj.TeacherID" v-bind:classSubject="obj.ID"></lesson-result>
                            </ul>
                        </b-collapse>

                    </div>
                </li>
            </ul>
        </div>
    </div>
</section>
@section Scripts{
    <style>
        .class_row a:nth-child(n+2) {
            display: none;
        }

        .class_row:hover a:nth-child(n+2) {
            display: block;
        }

        .sbjScoreCol {
            /*max-width: 90px;*/
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
            border-left: dashed 1px #dee2e6;
        }

        .item-body {
            padding: 10px;
            display: none;
        }

        .open > .item-body {
            display: block;
        }

        .item-body > div {
            display: inline-block;
        }

        .ls-practice .card-body {
            overflow: visible;
            padding-top: 0;
        }

        .ls-practice .list {
            max-height: none;
            overflow: visible;
        }

        /*.ls-practice .date {
            width: 160px;
            padding: 2px 12px;
        }*/

        .ls-practice .date::after {
            top: 7px;
        }

        .ls-practice .sub-practice .status {
            padding: 10px
        }

        .input-group.date input {
            border: solid 1px #DDD !important;
            padding: 0 5px !important;
            width: 125px;
            border: none;
            padding: 0;
        }

            .input-group.date input:read-only {
                background: #FFF;
            }

            .input-group.date input:focus {
                outline: none !important;
            }

        .sub-practice:hover {
            background: #DDD;
        }

        .chap-item {
            border-bottom: dashed 1px #CCC;
        }

        ul > .chap-item:last-child {
            border-bottom: none;
        }

        .basepoint::placeholder {
            color: #CCC;
        }

        .btn-collapse .fa-arrow-alt-circle-down {
            transform: rotate(90deg);
            font-size: 125%;
        }

        .btn-collapse.collapsed .fa-arrow-alt-circle-down {
            transform: none;
        }

        .chapSelect .lbl {
            white-space: nowrap;
        }

        .chap-item .chap-row {
            position: relative;
        }

            .chap-item .chap-row .row-action {
                position: absolute;
                top: 0;
                right: 0;
                padding: 3px 7px;
                background: #FFF;
            }

                .chap-item .chap-row .row-action .act_ic {
                    display: none;
                }

                .chap-item .chap-row .row-action .indicator {
                    display: block;
                    color: #CCC;
                    font-size: 12px;
                }

                .chap-item .chap-row:hover .row-action .indicator,
                .chap-item .chap-row .row-action.active .indicator {
                    display: none;
                }

                .chap-item .chap-row:hover .row-action .act_ic,
                .chap-item .chap-row .row-action.active .act_ic {
                    display: contents;
                }

        .ic-ac {
            color: #CCC;
            cursor: pointer;
        }

            .ic-ac.active, .ic-ac:hover {
                color: #333;
                cursor: pointer;
            }

        .chap-item .chap-row .chap-info i {
            font-size: 75%;
            font-weight: 500;
            color: #333;
            border-radius: 20px;
            padding: 2px 5px;
        }

            .chap-item .chap-row .chap-info i span {
                font-size: 100%;
                font-family: 'Be Vietnam',sans-serif;
            }

        .ui-tooltip, .arrow:after {
            background: black;
            border: 1px solid white;
        }

        .ui-tooltip {
            padding: 2px 7px 5px;
            color: white;
            border-radius: 10px;
            font: normal 12px 'Be Vietnam',sans-serif;
            box-shadow: none;
        }

        .arrow {
            width: 70px;
            height: 16px;
            overflow: hidden;
            position: absolute;
            left: 50%;
            margin-left: -35px;
            bottom: -16px;
        }

            .arrow.top {
                top: -16px;
                bottom: auto;
            }

            .arrow.left {
                left: 20%;
            }

            .arrow:after {
                content: "";
                position: absolute;
                left: 20px;
                top: -20px;
                width: 25px;
                height: 25px;
                box-shadow: 6px 5px 9px -9px black;
                -webkit-transform: rotate(45deg);
                -ms-transform: rotate(45deg);
                transform: rotate(45deg);
            }

            .arrow.top:after {
                bottom: -20px;
                top: auto;
            }
    </style>

    <script type="text/x-template" id="chapContentTemp">
        <li class="pr-0 ml-3 chap-item">
            <div class="inner pt-2 pb-2">
                <div class="chap-row mt-1" onmouseover="$('.row-action.active').removeClass('active')">
                    <a href="javascript:;" v-b-toggle="`prc-${data.ID}-${pos}`" class="blue-color btn-collapse flex-grow-1 mb-0" v-on:click="loadContent(data.ClassSubject, data.ID)">
                        <div class="align-self-center mb-1" style="line-height:24px">
                            <i class=" ic far fa-folder mr-2"></i>{{data.Title + ' (' + data.TotalLessons +  ')'}}
                            <i class="ic ic-collapse"></i>
                        </div>
                    </a>
                    <div>
                        <div class="d-flex justify-content-between align-items-start align-items-md-center">
                            <div class="chap-info ml-3" style="color:#999; white-space: nowrap">
                                <i class="ti-link" style="background-color: #bee4ef;" v-for="(chap,j) in listchaps" v-if="(data.ConditionChapter != '') && (chap.ID == data.ConditionChapter)"><span class="pl-1">Điều kiện: {{chap.Title}}</span></i>
                                <i class="ti-target ml-2" v-if="data.BasePoint > 0" style="background-color: #ffe38d"><span class="pl-1">Mục tiêu: {{data.BasePoint}}</span></i>
                                <i class="ti-control-play ml-2" style="background-color: #c3e2c3" v-if="moment(data.StartDate) > moment(new Date(1900,1,1))"><span class="pl-1">bắt đầu {{formatTime(data.StartDate)}}</span></i>
                                <i class="ti-timer ml-2" style="background-color: #fbcbcb" v-if="moment(data.EndDate) > moment(new Date(1900,1,1))"><span class="pl-1">hết hạn {{formatTime(data.EndDate)}}</span></i>
                            </div>

                            <div class="row-action d-flex align-items-start align-items-md-center" v-if="owner == '@currentuser'">
                                <i class="fas fa-ellipsis-h indicator"></i>
                                <div class="act_ic">
                                    <i class="ic-ac fas fa-link ml-2" style="font-size:16px;" title="Chọn nội dung điều kiện" onclick='$(".row-action").removeClass("active");$(this).closest(".row-action").addClass("active");$(this).siblings().focus().click()'></i>
                                    <select v-model="data.ConditionChapter" style="max-width:200px; font-size:90%; height: 24px; margin:2px; display:none" v-on:change="updateChapCondition(data)" onblur="$(this).hide()" onfocus="$(this).show()">
                                        <option value="">-- Chọn nội dung điều kiện (nếu có) --</option>
                                        <template v-for="(chap,j) in listchaps" v-if="(chap.ID != data.ID && chap.Parent == data.Parent) || (chap.ID == data.ConditionChapter)">
                                            <option :value='chap.ID'>{{chap.Title}}</option>
                                        </template>
                                    </select>
                                </div>
                                <div class="act_ic">
                                    <i class="ic-ac far fa-play-circle ml-2" style="font-size:18px;" title="Chọn ngày bắt đầu" onclick='$(".row-action").removeClass("active");$(this).closest(".row-action").addClass("active");$(this).siblings().find("input").focus().click()'></i>
                                    <datepickerV2 :date="data.StartDate" :idx="0" :obj="data" class="st" v-on:input="updateChapSchedule(data, pos)"></datepickerV2>
                                </div>
                                <div class="act_ic">
                                    <i class="ic-ac far fa-stop-circle ml-2" style="font-size:18px;" title="Chọn ngày hết hạn" onclick='$(".row-action").removeClass("active");$(this).closest(".row-action").addClass("active");$(this).siblings().find("input").focus().click()'></i>
                                    <datepickerV2 :date="data.EndDate" :idx="1" :obj="data" v-on:input="updateChapSchedule(data, pos)"></datepickerV2>
                                </div>
                                <div class="act_ic">
                                    <i class="ic-ac far fa-dot-circle ml-2" style="font-size:18px;" title="Đặt mục tiêu" onclick='$(".row-action").removeClass("active");$(this).closest(".row-action").addClass("active");$(this).siblings().focus().click()'></i>
                                    <input type="text" class="form-control bg-light text-right basepoint" style="margin: 0 3px;padding: 2px; width: 52px; height:24px; display:none;" onblur="$(this).hide()" onfocus="$(this).show()" v-model="data.BasePoint" placeholder="0-100" v-on:blur="updateChapPoint(data)">
                                </div>
                                <div class="act_ic">
                                    <i class="ic-ac fas fa-redo ml-2" style="font-size:16px;" title="Xóa lịch" v-on:click="clearChapSchedule(data, pos)"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <b-collapse :id="`prc-${data.ID}-${pos}`" :accordion="`my-accordion-${data.Parent}`" role="tabpanel">
                    <b-card-body class="pr-0">
                        <ul class="list">
                            <template v-if="data.IsLoading">
                                <li><i class=""></i> Đang nạp dữ liệu</li>
                            </template>
                            <template v-else>
                                <chap-content v-for="(subItem,j) in listchaps" v-if="subItem.ClassSubject + '-' + subItem.Parent == classbj + '-' + data.ID"
                                              v-bind:data="subItem"
                                              v-bind:classbj="classbj"
                                              v-bind:pos="j"
                                              v-bind:owner="owner"
                                              v-bind:listchaps="listchaps"></chap-content>
                                <lesson-item v-for="lesson in filterLesson(data)" v-bind:data="lesson" v-bind:owner="owner" v-bind:classSubject="data.ClassSubject"></lesson-item>
                            </template>
                        </ul>
                    </b-card-body>
                </b-collapse>
            </div>
        </li>
    </script>

    <script type="text/x-template" id="lessonItemTemp">
        <li class="sub-practice pt-2 pb-1 pl-2 rounded">
            <div class="d-flex w-100 flex-column flex-md-row align-items-start align-items-md-center">
                <a :href="'@processUrl("Detail", "Lesson")/' + data.ID + '/' + classSubject" class="flex-grow-1 overflow-hidden text-dark" style="text-overflow: ellipsis" :title="data.Title">
                    <span>
                        <i v-if="data.TemplateType === 2" class="ic far fa-edit mr-2"></i>
                        <i v-else class="ic far fa-file-alt mr-2"></i>
                        {{data.Title}}
                    </span>
                </a>
                <div class="picker-schedule d-flex align-items-center" v-if="owner == '@currentuser'">
                    <datepicker :date="data.StartDate" :idx="0" :obj="data" class="date st mr-2" v-on:input="updateSchedule(data)"></datepicker>
                    <datepicker :date="data.EndDate" :idx="1" :obj="data" class="date ed mr-2 ml-0" v-on:input="updateSchedule(data)"></datepicker>
                    <i class="fas fa-redo ic-ac d-flex align-items-center ml-2" title="Xóa lịch học" v-on:click="clearSchedule(data)"></i>
                    <i class="far fa-eye-slash ic-ac d-flex align-items-center ml-2" v-bind:class="{active: data.IsHideAnswer == true}" title="Bật/ tắt ẩn đáp án" data-toggle="tooltip" v-on:click="toggleHideAnswer(data)"></i>
                    <i class="fas fa-desktop ic-ac d-flex align-items-center ml-2" v-bind:class="{active: data.IsOnline == true}" title="Bật/ tắt học trực tuyến" data-toggle="tooltip" v-on:click="toggleOnlineClass(data)"></i>
                </div>
                <div class="d-flex picker-schedule" v-else>
                    <div class="input-group date date st bg-light mr-2"><input type="text" class="form-control bg-light" disabled="disabled" :value="formatTime(data.StartDate)"></div>
                    <div class="input-group date date ed bg-light mr-2"><input type="text" class="form-control bg-light" disabled="disabled" :value="formatTime(data.EndDate)"></div>
                    <i class="far fa-eye-slash ic-ac d-flex align-items-center ml-2" v-bind:class="{active: data.IsHideAnswer == true}"></i>
                    <i class="fas fa-desktop ic-ac d-flex align-items-center ml-2" v-bind:class="{active: data.IsOnline == true}"></i>
                </div>
                @*<div class="status" v-if="owner == '@currentuser'">
                        <b-form-checkbox switch v-model="data.IsActive" v-on:change="toggleLessonState(data)"></b-form-checkbox>
                    </div>*@
            </div>
        </li>
    </script>

    <script type="text/x-template" id="chapResultTemp">
        <li class="pr-0 ml-3 chap-item">
            <div class="inner pt-2 pb-2">
                <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center">
                    <a href="javascript:;" v-b-toggle="`prc-result-${data.ID}-${pos}`" class="blue-color btn-collapse flex-grow-1 mb-0" v-on:click="loadResult(data.ClassSubject, data.ID)">
                        <span class="align-self-center" style="line-height:24px;"><i class=" ic far fa-folder mr-2"></i>{{data.Title + ' (' + data.TotalLessons +  ')'}}<i class="ic ic-collapse"></i></span>
                    </a>
                </div>
                <b-collapse :id="`prc-result-${data.ID}-${pos}`" :accordion="`my-accordion-result-${data.Parent}`" role="tabpanel">
                    <b-card-body class="pr-0">
                        <ul class="list">
                            <template v-if="data.IsLoading">
                                <li><i class=""></i> Đang nạp dữ liệu</li>
                            </template>
                            <template v-else>
                                <chap-result v-for="(subItem,j) in listchaps" v-if="subItem.ClassSubject + '-' + subItem.Parent == classbj + '-' + data.ID"
                                             v-bind:data="subItem"
                                             v-bind:classbj="classbj"
                                             v-bind:pos="j"
                                             v-bind:owner="owner"
                                             v-bind:listchaps="listchaps"></chap-result>

                                <li class="sub-practice pt-2 pb-2 pl-2 rounded" v-if="filterResult(data).length > 0">
                                    <div class="d-flex w-100 flex-column flex-md-row align-items-start align-items-md-center font-weight-bold">
                                        <span class="flex-grow-1 overflow-hidden text-dark" style="text-overflow: ellipsis">
                                            Tên bài
                                        </span>
                                        <div class="flex-column col-3">
                                            Tỉ lệ mở
                                        </div>
                                        <div class="flex-column col-3">
                                            Tỉ lệ làm bài
                                        </div>
                                    </div>
                                </li>
                                <lesson-result v-for="lesson in filterResult(data)" v-bind:data="lesson" v-bind:classSubject="data.ClassSubject"></lesson-result>
                            </template>
                        </ul>
                    </b-card-body>
                </b-collapse>
            </div>
        </li>
    </script>

    <script type="text/x-template" id="lessonResultTemp">
        <li class="sub-practice pt-2 pb-2 pl-2 rounded">
            <div class="d-flex w-100 flex-column flex-md-row align-items-start align-items-md-center" v-on:click="openLessonResult(data)">
                <a class="flex-grow-1 overflow-hidden text-dark" style="text-overflow: ellipsis" :title="data.Title">
                    <span>
                        <i v-if="data.TemplateType === 2" class="ic far fa-edit mr-2"></i>
                        <i v-else class="ic far fa-file-alt mr-2"></i>
                        {{data.Title}}
                    </span>
                </a>
                <div class="flex-column col-3">
                    @*<span>
                            Tỉ lệ mở
                        </span>*@
                    <div class="progress m-0 p-0" style="height:1.5rem; font-size:110%;">
                        @if (currentClass.TotalStudents > 0)
                        {
                            @:<div class="progress-bar bg-success progress-bar-striped" role="progressbar" :aria-valuenow="data.LearntCount"
                                    @: aria-valuemin="0" aria-valuemax="@currentClass.TotalStudents" :class="(data.LearntCount > 0) ? 'text-white':'text-dark'"
                                    @: :style="'width:' + (data.LearntCount*100/@currentClass.TotalStudents) + '%'">
                                @:    <span>{{data.LearntCount}}/@currentClass.TotalStudents</span>
                            @:</div>
                        }
                    </div>
                </div>
                <div class="flex-column col-3">
                    @*<span>
                            Tỉ lệ làm bài
                        </span>*@
                    <div class="progress m-0 p-0" style="height:1.5rem; font-size:110%;">
                        @if (currentClass.TotalStudents > 0)
                        {
                            @:<div class="progress-bar bg-info progress-bar-striped" role="progressbar" :aria-valuenow="data.ExamCount"
                                    @: aria-valuemin="0" aria-valuemax="@currentClass.TotalStudents" :class="(data.ExamCount > 0) ? 'text-white':'text-dark'"
                                    @: :style="'width:' + (data.ExamCount*100/@currentClass.TotalStudents) + '%'">
                                @:    <span>{{data.ExamCount}}/@currentClass.TotalStudents</span>
                            @:</div>
                        }
                    </div>
                </div>
            </div>
        </li>
    </script>

    <script>
        Vue.use(VueQuillEditor)

        Vue.component('chap-content', {
            template: '#chapContentTemp',
            props: {
                listchaps: Array,
				classbj: String,
                lessons: Array,
                data: Object,
                pos: String,
                owner: String,
            }
        })

        Vue.component('lesson-item', {
            template: '#lessonItemTemp',
            props: {
                data: Object,
                classSubject: String,
                owner: String
            }
        })

        Vue.component('chap-result', {
            template: '#chapResultTemp',
            props: {
                listchaps: Array,
                classbj: String,
                lessons: Array,
                data: Object,
                pos: String,
                owner: String,
            }
        })

        Vue.component('lesson-result', {
            template: '#lessonResultTemp',
            props: {
                data: Object,
                classSubject: String,
                owner: String
            }
        })

        var datepickerComponent = Vue.extend({
          //v-el:select
          template: `<div class="input-group date" ref="inputgroup">` +
            `<input type="text" class="form-control" v-model="dateVal" readonly="readonly" style="font-size:95%">` +
            `</div>`,
            props: {
                obj: '',
                idx: '0',
                date: '2015-01-01'
            },
            data: function () {
                return {};
            },
            computed:
            {
                dateVal: {
                    get() {
                        //var _date = moment(this.date);

                        //if (!_date._isValid || _date <= moment(new Date(1900, 1, 1)))
                        //    return '';
                        //return _date.format("DD/MM/YYYY HH:mm");
                        return formatTime(this.date);
                    },
                    set(value) {
                        var _date = moment(value, "DD/MM/YYYY HH:mm");
                        if (_date._isValid)
                            this.date = _date.format();
                        else
                            this.date = '';
                    }
                }
            },
            mounted: function () {
                let _that = this
                Vue.nextTick(function () {
                    //console.log($(_that.$refs.inputgroup))
                    $($(_that.$refs.inputgroup).find('input')).datetimepicker({
                        formatTime: 'H:i',
                        formatDate: 'd/m/Y',
                        timepickerScrollbar: true,
                        scrollMonth: false,
                        defaultTime: '08:00',
                        step: 15,
                        onChangeDateTime: function (dp, $input) {
                            //console.log($input.val())
                            _that.dateVal = $input.val()
                            if (moment($input.val(),"DD/MM/YYYY HH:mm").format() == "Invalid date") {
                                //console.log('false');
                                return false;
                            }

                            if (_that.idx == '0') {
                                if (_that.obj.StartDate != _that.date) {
                                    _that.obj.StartDate = _that.date
                                    //console.log(_that.obj.StartDate + ' _ ' + _that.obj.EndDate)
                                    _that.$emit('input')
                                }
                            }
                            else {
                                if (_that.obj.EndDate != _that.date) {
                                    _that.obj.EndDate = _that.date
                                    //console.log(_that.obj.StartDate + ' _ ' + _that.obj.EndDate)
                                    _that.$emit('input')
                                }
                            }
                        }
                    })
                })
            }
        })

        var datepickerComponentV2 = Vue.extend({
            //v-el:select
            template: `<div class="date" ref="inputgroup">` +
                `<input type="text" v-model="dateVal" readonly="readonly" style="width:0px;height:0px; border:none !important; outline:none !important">` +
                `</div>`,
            props: {
                obj: '',
                idx: '0',
                date: '2015-01-01'
            },
            data: function () {
                return {};
            },
            computed:
            {
                dateVal: {
                    get() {
                        //var _date = moment(this.date);

                        //if (!_date._isValid || _date <= moment(new Date(1900, 1, 1)))
                        //    return '';
                        //return _date.format("DD/MM/YYYY HH:mm");
                        return formatTime(this.date);
                    },
                    set(value) {
                        var _date = moment(value, "DD/MM/YYYY HH:mm");
                        if (_date._isValid)
                            this.date = _date.format();
                        else
                            this.date = '';
                    }
                }
            },
            mounted: function () {
                let _that = this
                Vue.nextTick(function () {
                    //console.log($(_that.$refs.inputgroup))
                    $($(_that.$refs.inputgroup).find('input')).datetimepicker({
                        formatTime: 'H:i',
                        formatDate: 'd/m/Y',
                        timepickerScrollbar: true,
                        scrollMonth: false,
                        defaultTime: '08:00',
                        step: 15,
                        onChangeDateTime: function (dp, $input) {
                            //console.log($input.val())
                            _that.dateVal = $input.val()
                            if (moment($input.val(), "DD/MM/YYYY HH:mm").format() == "Invalid date") {
                                //console.log('false');
                                return false;
                            }

                            if (_that.idx == '0') {
                                if (_that.obj.StartDate != _that.date) {
                                    _that.obj.StartDate = _that.date
                                    //console.log(_that.obj.StartDate + ' _ ' + _that.obj.EndDate)
                                    _that.$emit('input')
                                }
                            }
                            else {
                                if (_that.obj.EndDate != _that.date) {
                                    _that.obj.EndDate = _that.date
                                    //console.log(_that.obj.StartDate + ' _ ' + _that.obj.EndDate)
                                    _that.$emit('input')
                                }
                            }
                        }
                    })
                })
            }
        })

        Vue.component('datepicker', datepickerComponent);
        Vue.component('datepickerV2', datepickerComponentV2);

        var mainInstance = new Vue({
            el: "#main_content",
            mounted() {
                this.list_subject = @Html.Raw(Json.Serialize(listsubjects));
                this.list_grades_full = @Html.Raw(Json.Serialize(listgrades));
                window.loadContent = this.loadContent
                window.loadResult = this.loadResult
                window.updateSchedule = this.updateSchedule
                window.updateChapPoint = this.updateChapPoint
                window.updateChapSchedule = this.updateChapSchedule
                window.updateChapCondition = this.updateChapCondition
                window.clearSchedule = this.clearSchedule
                window.clearChapSchedule = this.clearChapSchedule
                window.toggleLessonState = this.toggleLessonState
                window.toggleOnlineClass = this.toggleOnlineClass
                window.toggleHideAnswer = this.toggleHideAnswer
                window.filterChap = this.filterChap
                window.filterLesson = this.filterLesson
                window.filterResult = this.filterResult
                window.openLessonResult = this.openLessonResult
                window.formatTime = this.formatTime
                window.openHistory = this.openHistory
                var hash = window.location.hash;
                if (hash.startsWith('#')) {
                    var hash = hash.split('#')[1];

                    switch (hash) {
                        case 'info':
                            this.tabChange(0);
                            break;
                        case 'module':
                            this.tabChange(1);
                            break;
                        case 'score':
                            this.tabChange(2);
                            break;
                        case 'reference':
                            this.tabChange(3);
                            break;
                        case 'result':
                            this.tabChange(4);
                            break;
                    }
                }
                else {
                    this.tabChange(1);
                }
            },
            components: {
                LocalQuillEditor: VueQuillEditor.quillEditor
            },
            data: {
                isLoading: false,
                editorOption: {
                    theme: 'snow'
                },
                searchCsbj:'',
                classID: '@currentClass.ID',
                className: '@currentClass.Name',
                startDate: '@currentClass.StartDate',
                endDate: '@currentClass.EndDate',
                classDescription: '@currentClass.Description',
                classImg: '@currentClass.Image',
                subjectName: '@currentClass.SubjectName',
                skillName: '@currentClass.SkillName',
                classSubjects: [],
                list_data: [],
                list_subjects: [],
                list_chapters: [],
                list_chapters_result: [],
                list_lessons: [],
                list_lessons_result: [],
                loaded_chapter: [],
                loaded_chapter_result: [],
                loaded_subject: [],
                loaded_subject_result: [],
                result_data: [],
                init: true,
                fields: [
                    {
                        key: 'stt',
                        label: '#'
                    },
                    {
                        key: 'name',
                        label: 'Họ tên'
                    },
                    //{
                    //    key: 'email',
                    //    label: 'Email'
                    //},
                    //{
                    //    key: 'phone',
                    //    label: 'SĐT'
                    //},
                    {
                        key: 'per',
                        label: 'Tiến độ'
                    },
                    {
                        key: 'last_update',
                        label: 'Lần học cuối'
                    },
                    {
                        key: 'practice',
                        label: 'Điểm luyện tập'
                    },
                    {
                        key: 'score',
                        label: 'Điểm kiểm tra'
                    },
                    {
                        key: 'rank',
                        label: 'Xếp hạng'
                    }
                ],
                scoreData: [
                ],
                scoreSbjChap: [],
                scoreSbjStudent: [],
                //view: 10,
                //page: 1,
                tab: [true, false, false, false, false],
                ref: {
                    range: '@BaseCustomerEntity.Database.REF_RANGE.CLASS',
                    target: '@currentClass.ID',
                    searchTerm: '',
                    data: [],
                    view: 10,
                    page: 1,
                    gradeID: '',
                    subjectID:'',
                },
                addRef: {
                    ID: '',
                    Title: '',
                    Range: '',
                    Link: '',
                    Target: '',
                    Description: '',
                    FileName: '',
                    file: null,
                    coverName: '',
                    cover: null,
                    Image: '',
                    subjectID: '',
                    gradeID: '',
                    isDownload: false,
                    tags: '',
                    isCheckDownload: false
                },
                filterChap: {
                    TargetChaps: [],
                    SelectAll: false
                },
                checkpoint: {
                    ID: '',
                    Point: '',
                    Answer: ''
                },
                lesson_result: {
                    ID: '',
                    Title: ''
                },
                student_result: {
                    ID: '',
                    Name: '',
                    History: []
                },
                linkFile: '',
                typeFile: [
                    "application/msword",
                    "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                    "application/vnd.ms-excel",
                    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    "application/pdf",
                    "application/vnd.ms-powerpoint",
                    "application/vnd.openxmlformats-officedocument.presentationml.presentation"
                ],
                allow_doc_ext: [".doc", ".docx", ".xlsx", ".xls", ".ptt", "pttx", ".pdf"],
                list_subject: [],
                list_grades_full: [],
                displaySelect: false
            },
            watch: {
                "ref.subjectID": function () {
                        this.loadPreference()
                },
                "ref.gradeID": function () {
                    this.loadPreference()
                },
                searchCsbj: function () {
                    this.loadClassScore()
                    this.filterChap.TargetChaps = []
                    this.filterChap.SelectAll = false;
                }
            },
            methods: {
                tabChange(a = 0) {
                    // có thể load data theo từng tab để tối ưu hiệu năng
                    // this.getData()
                    let _that = this
                    _that.tab.forEach(function (item, k) {
                        _that.tab[k] = false;
                    })
                    this.tab = _that.tab
                    this.tab[a] = true
                    switch (a) {
                        case 0:
                            history.replaceState({ tab: a }, this.className + " - Tổng quan", "#info");
                            break;
                        case 1:
                            history.replaceState({ tab: a }, this.className + " - Môn học", "#module");
                            this.loadClassSubjects();
                            break;
                        case 2:
                            history.replaceState({ tab: a }, this.className + " - Bảng điểm", "#score");
                            this.loadClassSubjects();
                            this.loadClassScore();
                            break;
                        case 3:
                            history.replaceState({ tab: a }, this.className + " - Tài liệu tham khảo", "#reference");
                            this.loadPreference();
                            break;
                        case 4:
                            history.replaceState({ tab: a }, this.className + " - Kết quả", "#result");
                            this.loadClassSubjects();
                            break;
                    }
                    this.$forceUpdate()
                },
                loadClassSubjects() {
                    let _that = this
                    if (_that.classSubjects.length > 0)
                        return;
                    _that.init = false;
                    let _form = new FormData()
                    _form.append('ClassID', _that.classID)
                    let _url = '@processUrl("GetClassSubjects", "ClassSubject")'
                    axios.post(_url, _form)
                        .then(response => {
                            var _data = response.data.Data;
                            _that.classSubjects = [];
                            //console.log(_that.classSubject)
                            _data.forEach(function (item, k) {
                                //debugger
                                _that.classSubjects.push({
                                    ID: item.ID,
                                    Title: item.SkillName,
                                    Image: item.SkillImage,
                                    Teacher: item.TeacherName,
                                    TeacherID: item.TeacherID,
                                    CourseName: item.CourseName,
                                    Color: item.Color,
                                    Chapters: [],
                                    Lessons: [],
                                    TypeClass:item.TypeClass
                                });
                                //loadContent(item.ID);
                                //_that.changeAddSubject(item)
                                //_that.changeAddGrade(item)
                            })
                            _that.init = true;
                        }).catch(e => { });

                    //this.$forceUpdate();
                    //this.$nextTick(function () {
                    //    console.log($(".list.ls-practice > li > .inner > .parent"));
                    //    $(".list.ls-practice > li > .inner > .parent").click();
                    //});
                },
                loadContent(subject, chapter) {

                    let _that = this
                    let key = subject + "_" + chapter
                    if (_that.loaded_chapter.includes(key))
                        return;
                    let _form = new FormData()
                    _form.append('ID', subject)
                    if (chapter)
                        _form.append('Parent', chapter)
                    let _url = '@processUrl("GetContents", "ClassSubject")'
                    axios.post(_url, _form)
                        .then(response => {
                            var _data = response.data.Data;
                            var _lesson = response.data.Lesson;
                            //_that.classSubjects.forEach(function (item, k)
                            //{
                            //    if (item.ID == subject) {
                            _data.forEach(function (chapter, k) {
                                var parent = chapter.ParentID;
                                if (parent == "0") { parent = ""; }
                                //var pr = _that.list_chapters.filter(t => t.ID == parent)[0];
                                //var prline = [];
                                //if (pr != null)
                                //    prline = pr.ParentLine.slice();
                                //prline.push(chapter.ID);
                                //console.log(prline);
                                _that.list_chapters.push({
                                    ID: chapter.ID,
                                    Title: chapter.Name,
                                    ClassSubject: subject,
                                    Parent: parent,
                                    //ParentLine: prline,
                                    TotalLessons: chapter.TotalLessons,
                                    StartDate: chapter.StartDate,
                                    EndDate: chapter.EndDate,
                                    BasePoint: chapter.BasePoint,
                                    ConditionChapter: chapter.ConditionChapter == null ? '' : chapter.ConditionChapter
                                })
                            })
                            _lesson.forEach(function (lesson, k) {
                                var parent = '';
                                if (lesson.ChapterID) {
                                    parent = lesson.ChapterID;
                                }

                                _that.list_lessons.push({
                                    ID: lesson.ID,
                                    ScheduleID: lesson.ScheduleID,
                                    Title: lesson.Title,
                                    TemplateType: lesson.TemplateType,
                                    ClassSubject: subject,
                                    Parent: parent,
                                    StartDate: moment(lesson.StartDate) > moment(new Date(1900, 1, 1)) ? lesson.StartDate : "",
                                    EndDate: moment(lesson.EndDate) > moment(new Date(1900, 1, 1)) ? lesson.EndDate : "",
                                    IsActive: lesson.IsActive,
                                    IsUpdating: false,
                                    IsOnline: lesson.IsOnline,
                                    IsHideAnswer: lesson.IsHideAnswer
                                })

                            })
                            this.loaded_chapter.push(key);
                            this.list_chapters = _that.list_chapters
                            this.list_lessons = _that.list_lessons
                            //_that.$forceUpdate()
                            Vue.nextTick(function () {
                                console.log($('.ls-practice [for=' + subject + ']'));
                                this.toggleTooltips($('.ls-practice [for=' + subject + ']'));
                            })
                        }).catch(e => { })
                },
                loadResult(subject, chapter) {

                    let _that = this
                    let key = subject + "_" + chapter
                    if (_that.loaded_chapter_result.includes(key))
                        return;
                    let _form = new FormData()
                    _form.append('ID', subject)
                    if (chapter)
                        _form.append('Parent', chapter)
                    let _url = '@processUrl("GetResults", "ClassSubject")'
                    axios.post(_url, _form)
                        .then(response => {
                            var _data = response.data.Data;
                            var _lesson = response.data.Lesson;
                            _data.forEach(function (chapter, k) {
                                var parent = chapter.ParentID;
                                if (parent == "0") { parent = ""; }
                                //var pr = _that.list_chapters.filter(t => t.ID == parent)[0];
                                //var prline = [];
                                //if (pr != null)
                                //    prline = pr.ParentLine.slice();
                                //prline.push(chapter.ID);
                                //console.log(prline);
                                _that.list_chapters_result.push({
                                    ID: chapter.ID,
                                    Title: chapter.Name,
                                    ClassSubject: subject,
                                    Parent: parent,
                                    //ParentLine: prline,
                                    TotalLessons: chapter.TotalLessons,
                                    StartDate: chapter.StartDate,
                                    EndDate: chapter.EndDate,
                                    BasePoint: chapter.BasePoint,
                                    ConditionChapter: chapter.ConditionChapter == null ? '' : chapter.ConditionChapter
                                })
                            })
                            _lesson.forEach(function (lesson, k) {
                                var parent = '';
                                if (lesson.ChapterID) {
                                    parent = lesson.ChapterID;
                                }

                                _that.list_lessons_result.push({
                                    ID: lesson.ID,
                                    ScheduleID: lesson.ScheduleID,
                                    Title: lesson.Title,
                                    TemplateType: lesson.TemplateType,
                                    ClassSubject: subject,
                                    Parent: parent,
                                    StartDate: moment(lesson.StartDate) > moment(new Date(1900, 1, 1)) ? lesson.StartDate : "",
                                    EndDate: moment(lesson.EndDate) > moment(new Date(1900, 1, 1)) ? lesson.EndDate : "",
                                    IsActive: lesson.IsActive,
                                    IsUpdating: false,
                                    IsOnline: lesson.IsOnline,
                                    LearntCount: lesson.LearntCount,
                                    ExamCount: lesson.ExamCount
                                })

                            })
                            this.loaded_chapter_result.push(key);
                            this.list_chapters_result = _that.list_chapters_result
                            this.list_lessons_result = _that.list_lessons_result                           
                            //_that.$forceUpdate()
                        }).catch(e => { })
                    //console.log(this.list_lessons_result);
                },
                loadClassScore() {
                    let _that = this
                    let _form = new FormData()

                    if (this.searchCsbj == '') {
                        _form.append('ClassID', _that.classID)
                        _form.append('PageSize', 1000)
                        _form.append('PageIndex', 1)
                        let _url = '@processUrl("GetClassResult", "Class")'
                        axios.post(_url, _form)
                            .then(response => {
                                //console.log(response.data);
                                _that.scoreData = response.data.Data;
                                this.scoreData = _that.scoreData
                                this.totalRec = response.data.Model.totalRecord
                                //var tt = response.data.Model.totalRecord;
                                //this.max_page = Math.floor(tt / this.view) + (tt % this.view > 0 ? 1 : 0);
                            }).catch(e => { })
                    }
                    else {
                        _form.append('ClassSubjectID', this.searchCsbj)
                        _form.append('PageSize', 1000)
                        _form.append('PageIndex', 1)
                        let _url = '@processUrl("GetClassSubjectResult", "Class")'
                        axios.post(_url, _form)
                            .then(response => {
                                _that.scoreSbjChap = response.data.Chapter;
                                _that.scoreSbjStudent = response.data.Student;
                                var result = response.data.Result;
                                if (_that.scoreSbjChap.length > 0) {
                                    for (i = 0; i < _that.scoreSbjChap.length; i++) {
                                        if(i < 2) this.filterChap.TargetChaps.push(_that.scoreSbjChap[i].ID);
                                        if (result != null)
                                            _that.scoreSbjChap[i].Result = result[i];
                                    }
                                    if(_that.scoreSbjChap.length <= 2)
                                        this.filterChap.SelectAll = true;
                                }
                                this.scoreSbjChap = _that.scoreSbjChap
                                this.scoreSbjStudent = _that.scoreSbjStudent
                                this.totalRec = response.data.Model.totalRecord
                                //var tt = response.data.Model.totalRecord;
                                //this.max_page = Math.floor(tt / this.view) + (tt % this.view > 0 ? 1 : 0);                              
                            }).catch(e => { })
                    }
                },
                loadPreference() {
                    //console.log(4)
                    let _that = this
                    let _form = new FormData()
                    _form.append('SearchText', "")
                    _form.append('Target', _that.ref.target)
                    _form.append('PageSize', _that.ref.view)
                    _form.append('PageIndex', _that.ref.page)
                    _form.append('SubjectID', _that.ref.subjectID)
                    _form.append('GradeID', _that.ref.gradeID)
                    let _url = '@processUrl("GetClassList", "Reference")'

                    axios.post(_url, _form)
                        .then(response => {
                            _that.ref.data = response.data.Data;
                            this.ref.data = _that.ref.data
                            this.ref.totalRec = response.data.Model.totalRecord
                            console.log(totalRec)
                            //var tt = response.data.Model.totalRecord;
                            //this.max_page = tt / this.view + (tt % this.view > 0 ? 1 : 0);
                            //console.log(_that.active_course);
                        }).catch(e => { })
                },
                loadExamStudent() {
                    let _that = this
                    let _form = new FormData()
                    //_form.append('SearchText', "")
                    _form.append('ClassID', _that.ref.target)
                    _form.append('PageSize', _that.ref.view)
                    _form.append('PageIndex', _that.ref.page)

                    let _url = '@processUrl("GetListStudents", "Exam")'

                    axios.post(_url, _form)
                        .then(response => {
                            _that.ref.data = response.data.Data;
                            this.ref.data = _that.ref.data
                            this.ref.totalRec = response.data.Model.totalRecord
                            console.log(totalRec)
                            //var tt = response.data.Model.totalRecord;
                            //this.max_page = tt / this.view + (tt % this.view > 0 ? 1 : 0);
                            //console.log(_that.active_course);
                        }).catch(e => { })
                },
                loadComment() {
                    @*document.location = '@processUrl("Index","Discuss", new { id = currentClass.ID })'*@
                    //console.log(5)
                    $('.fn-box-chat-eduso').focus().click()
                },

                //MODULE
                updateSchedule(obj) {
                    obj.IsUpdating = true

                    var startdate = moment(obj.StartDate).format("MM-DD-YYYY HH:mm:ss");
                    var enddate = moment(obj.EndDate).format("MM-DD-YYYY HH:mm:ss");

                    let _form = new FormData()
                    _form.append('ID', obj.ScheduleID)
                    _form.append('StartDate', startdate)
                    _form.append('EndDate', enddate)
                    let _url = '@processUrl("Update", "LessonSchedule")'
                    axios.post(_url, _form)
                        .then(response => {
                            obj.IsUpdating = false
                            if (response.Data.Error != null) {
                                 Swal.fire({
                                        title: "Có lỗi",
                                        text: "Vui lòng nạp lại trang và thao tác lại",
                                        icon: 'warning',
                                    });
                            }
                        }).catch(e => {
                        })
                },
                updateChapPoint(obj) {
                    if (!(obj.BasePoint >= 0 && obj.BasePoint <= 100)) {
                        obj.BasePoint = 0;
                        return false;
                    }
                    obj.IsUpdating = true;
                    let _form = new FormData()
                    _form.append('ID', obj.ID)
                    _form.append('BasePoint', obj.BasePoint)
                    let _url = '@processUrl("UpdateChapterPoint", "Lesson")'

                    axios.post(_url, _form)
                        .then(response => {
                            console.log(obj);
                            obj.IsUpdating = false;
                            mainInstance.$forceUpdate();
                            var chapter = response.data.Data;
                            if (chapter == null) {
                                alert("có lỗi, vui lòng tải lại trang & thực hiện lại thao tác");
                                return false;
                            }
                        }).catch(e => { })
                },
                updateChapCondition(obj) {
                    if (obj.PreventEvent) return false;
                    obj.IsUpdating = true;
                    let _form = new FormData()
                    _form.append('ID', obj.ID)
                    _form.append('ConditionChapter', obj.ConditionChapter)
                    let _url = '@processUrl("UpdateConditionChapter", "Lesson")'

                    axios.post(_url, _form)
                        .then(response => {
                            obj.IsUpdating = false;
                            mainInstance.$forceUpdate();
                            var chapter = response.data.Data;
                            if (chapter == null) {
                                alert("có lỗi, vui lòng tải lại trang & thực hiện lại thao tác");
                                return false;
                            }
                            else {
                                this.updateSubchapCondition(chapter);
                            }
                        }).catch(e => { })
                },
                updateSubchapCondition(parent) {
                    if (parent != null) {
                        var subchaps = this.list_chapters.filter(t => t.Parent == parent.ID);
                        if (subchaps.length > 0) {
                            subchaps.forEach(function (item, pos) {
                                //console.log(item);
                                item.PreventEvent = true;
                                //console.log(parent);
                                if (parent.ConditionChapter != null)
                                    item.ConditionChapter = parent.ConditionChapter;
                                else
                                    item.ConditionChapter = "";

                                Vue.nextTick(function () {
                                    this.updateSubchapCondition(item);
                                    item.PreventEvent = false
                                })
                            });
                        }
                    }
                },
                updateChapSchedule(obj, pos) {
                    obj.IsUpdating = true
                    var startdate = moment(obj.StartDate).format("MM-DD-YYYY HH:mm:ss");
                    var enddate = moment(obj.EndDate).format("MM-DD-YYYY HH:mm:ss");

                    let _form = new FormData()
                    _form.append('ID', obj.ID)
                    _form.append('StartDate', startdate)
                    _form.append('EndDate', enddate)
                    let _that = this;
                    let _url = '@processUrl("UpdateChapter", "LessonSchedule")'

                    axios.post(_url, _form)
                        .then(response => {
                            console.log(obj);
                            obj.IsUpdating = false;
                            mainInstance.$forceUpdate();
                            var chapter = response.data.Data;
                            if (chapter == null) {
                                alert("có lỗi, vui lòng tải lại trang & thực hiện lại thao tác");
                                return false;
                            }
                            else {
                                var _container = '#prc-' + chapter.ID + '-' + pos;
                                var startdate = formatTime(chapter.StartDate);
                                var enddate = formatTime(chapter.EndDate);
                                $(_container).find('.input-group.date.st > input').val(startdate);
                                $(_container).find('.input-group.date.ed > input').val(enddate);
                            }
                        }).catch(e => { })
                },
                clearSchedule(obj) {
                    obj.IsUpdating = true
                    obj.StartDate = ''
                    obj.EndDate = ''

                    let _form = new FormData()
                    _form.append('ID', obj.ScheduleID)
                    let _url = '@processUrl("Update", "LessonSchedule")'
                    axios.post(_url, _form)
                        .then(response => {
                            obj.IsUpdating = false
                        }).catch(e => { })
                },
                clearChapSchedule(obj, pos) {
                    obj.IsUpdating = true
                    obj.StartDate = ''
                    obj.EndDate = ''

                    let _form = new FormData()
                    _form.append('ID', obj.ID)
                    let _url = '@processUrl("UpdateChapter", "LessonSchedule")'
                    axios.post(_url, _form)
                        .then(response => {
                            console.log(obj);
                            obj.IsUpdating = false;
                            mainInstance.$forceUpdate();
                            var chapter = response.data.Data;
                            if (chapter == null) {
                                alert("có lỗi, vui lòng tải lại trang & thực hiện lại thao tác");
                                return false;
                            }
                            else {
                                var _container = '#prc-' + chapter.ID + '-' + pos;
                                var startdate = formatTime(chapter.StartDate);
                                var enddate = formatTime(chapter.EndDate);
                                $(_container).find('.input-group.date.st > input').val(startdate);
                                $(_container).find('.input-group.date.ed > input').val(enddate);
                            }
                        }).catch(e => { })
                },
                matchedChap(obj, key) {
                    return (obj.ClassSubject + '-' + obj.Parent) == key
                },
                matchedLesson(obj, key) {
                    return (obj.ClassSubject + '-' + obj.Parent) == key
                },
                filterChap(obj, list) {
                    return list.filter((p) => {
                        return p.Parent == obj.ID && p.ClassSubject == obj.ClassSubject
                    })
                },
                filterLesson(obj) {
                    var filter = this.list_lessons.filter((p) => {
                        return p.Parent == obj.ID && p.ClassSubject == obj.ClassSubject
                        console.log(1);
                    })
                    return filter;
                },
                filterResult(obj) {
                    //console.log(obj);
                    var filter = this.list_lessons_result.filter((p) => {
                        return p.Parent == obj.ID && p.ClassSubject == obj.ClassSubject
                    })
                    return filter;
                },
                //Lesson Action
                toggleLessonState(obj) {
                    let _that = this;
                    //console.log(obj)
                    //_that.tableData.forEach(function (item, k) {
                    //if (item.ID === obj.ID) {
                    let _url = obj.IsActive ? '@processUrl("Unpublish", "LessonSchedule")' : '@processUrl("Publish", "LessonSchedule")'
                    let _form = new FormData()
                    _form.append('ArrID', obj.ScheduleID);
                    axios.post(_url, _form)
                        .then(response => {
                            console.log('update ok');
                            //item.IsActive = !item.IsActive;
                            //_that.list_data[k].IsActive = !_that.list_data[k].IsActive;
                        }).catch(e => { })
                    //}
                    //})
                },
                toggleOnlineClass(obj) {
                    let _url = '@processUrl("ToggleOnline", "LessonSchedule")'
                    let _form = new FormData()
                    _form.append('ID', obj.ScheduleID);
                    axios.post(_url, _form)
                        .then(response => {
                            if (response.data.error == null) {
                                obj.IsOnline = response.data.isOnline;
                                if (response.data.isOnline == true) {
                                    Swal.fire({
                                        title: "Mở lớp thành công",
                                        text: "Đã mở lớp trực tuyến cho bài học",
                                        icon: 'success',
                                    });
                                }
                                else {
                                    Swal.fire({
                                        title: "Thông báo",
                                        text: "Đã hủy lớp trực tuyến",
                                        icon: 'warning',
                                    });
                                }
                            }
                            else {
                                Swal.fire({
                                    title: "Có lỗi",
                                    text: response.error,
                                    icon: 'warning',
                                });
                            }

                            //item.IsActive = !item.IsActive;
                            //_that.list_data[k].IsActive = !_that.list_data[k].IsActive;
                        }).catch(e => { })
                },

                toggleHideAnswer(obj) {
                    let _url = '@processUrl("ToggleHideAnswer", "LessonSchedule")'
                    let _form = new FormData()
                    _form.append('ID', obj.ScheduleID);
                    axios.post(_url, _form)
                        .then(response => {
                            if (response.data.error == null) {
                                console.log(response.data);
                                obj.IsHideAnswer = response.data.isHideAnswer;
                                if (response.data.isHideAnswer == true) {
                                    Swal.fire({
                                        title: "Thông báo",
                                        text: "Đã bật chế độ ẩn đáp án",
                                        icon: 'info',
                                    });
                                }
                                else {
                                    Swal.fire({
                                        title: "Thông báo",
                                        text: "Đã tắt chế độ ẩn đáp án",
                                        icon: 'info',
                                    });
                                }
                            }
                            else {
                                Swal.fire({
                                    title: "Có lỗi",
                                    text: response.error,
                                    icon: 'warning',
                                });
                            }

                            //item.IsActive = !item.IsActive;
                            //_that.list_data[k].IsActive = !_that.list_data[k].IsActive;
                        }).catch(e => { })
                },
                //REF
                showRefModal(obj) {
                    let _that = this;
                    this.hideModal();
                    if (obj == null) {
                        _that.addRef.ID = '';
                        _that.addRef.Title = '';
                        _that.addRef.Range = '@BaseCustomerEntity.Database.REF_RANGE.ALL';
                        _that.addRef.Link = '';
                        _that.addRef.Target = '@currentClass.ID';
                        _that.addRef.Description = '';
                        _that.addRef.FileName = '';
                        _that.addRef.coverName = '';
                        _that.addRef.Image = '';
                        _that.addRef.subjectID = '';
                        _that.addRef.gradeID = '';
                        _that.addRef.isDownload = false;
                        _that.addRef.Tags = '';
                        _that.addRef.isCheckDownload = false;
                        _that.addRef.cover = null;
                    }
                    else {
                        _that.addRef.ID = obj.ID;
                        _that.addRef.Title = obj.Title;
                        _that.addRef.Range = obj.Range;
                        _that.addRef.Link = obj.Link;
                        _that.addRef.Description = obj.Description;
                        _that.addRef.Target = obj.Target;
                        _that.addRef.Image = obj.Image;
                        _that.addRef.subject = obj.SubjectID;
                        _that.addRef.gradeID = obj.GradeID;
                        _that.addRef.isDownload = obj.isDownload;
                        _that.addRef.tags = obj.Tags;
                        _that.addRef.cover = null;
                        if (obj.Media != null) {
                            _that.addRef.FileName = obj.Media.Name;
                            _that.addRef.isCheckDownload = true;
                        }
                        else {
                            _that.addRef.FileName = '';
                            _that.addRef.isCheckDownload = false;
                        }

                        if (obj.Image != null) {
                            _that.addRef.Image = obj.Image;
                            _that.cover = null;
                        }
                    }
                    _that.addRef.file = {};
                    _that.$bvModal.show('modal_event')
                },
                showPointModal(obj) {
                    let _that = this;
                    let _url = '@processUrl("GetDetail", "Exam")'
                    let _form = new FormData()
                    //_form.append('ID', obj);
                    _form.append('CheckPoint', true);
                    axios.post(_url, _form)
                        .then(response => {
                            var data = response.data.Data;
                            _that.checkpoint = data;
                            if (data != null) {
                                var questionEssay = [];
                                for (var i = 0; i < data.Parts.length; i++) {
                                    var part = data.Parts[i];
                                    if (part.Type == "ESSAY") {
                                        questionEssay = questionEssay.length == 0 ? [...part.ExamDetails] : [...questionEssay,...part.ExamDetails];
                                    }
                                }
                                //loadCheckPointData(data, questionEssay);
                            }

                        }).catch(e => { })

                    _that.$bvModal.show('modal_essay');
                },
                openLink(obj) {
                    obj.Viewed = obj.Viewed + 1;
                    window.open('@processUrl("OpenLink", "Reference")/' + obj.ID);
                },
                download(obj) {
                    if (obj.Media == null)
                        return false;
                    obj.Downloaded = obj.Downloaded + 1;
                    window.open('@processUrl("Download", "Reference")/' + obj.ID);
                },
                updateCheckPoint() {
                    let _that = this
                    for (var i = 0; i < _that.checkpoint.Parts.length; i++) {
                        var part = _that.checkpoint.Parts[i];
                        if (part.Type == "ESSAY") {
                            for (var j = 0; j < part.ExamDetails.length; j++) {
                                var question = part.ExamDetails[j];
                                let _form = new FormData();
                                _form.append("ID", question.ID);
                                _form.append("Point", question.Point);
                                _form.append("RealAnswerValue", question.RealAnswerValue);
                                _form.append("isLast", j == (part.ExamDetails.length - 1));

                                var files = document.querySelector('input[data-target="' + question.ID + '"]');
                                if (files != null) {
                                    for (var x = 0; x < files.files.length; x++) {
                                        _form.append("files", files.files[x]);
                                    }
                                }

                                let _url = '@processUrl("UpdatePoint", "Exam")'
                                axios.post(_url, _form)
                                    .then(response => {
                                        console.log(response.data);
                                        var data = response.data.Data;
                                        if (data != null && data != void 0) {
                                            if (j == (part.ExamDetails.length - 1)) {
                                                Swal.fire({
                                                    title: "Đã chấm xong",
                                                    text: "Success",
                                                    icon: 'Success',
                                                });
                                                _that.checkpoint.Marked = true;
                                            }
                                        } else {
                                            Swal.fire({
                                                title: "Có lỗi",
                                                text: "Vui lòng nhập đủ thông tin",
                                                icon: 'warning',
                                            });
                                        }
                                }).catch(e => { })

                            }
                        }
                    }
                    if (_that.checkpoint.RealAnswer == '') {
                        Swal.fire({
                            title: "Có lỗi",
                            text: "Vui lòng nhập đủ thông tin",
                            icon: 'warning',
                        });
                        //this.$refs["addName"].focus();
                        return false;
                    }
                    _that.hideModal();
                },
                updateRef() {
                    let _that = this
                    let _form = new FormData()


                    if (_that.addRef.Title == '') {
                        swal.fire({
                            title: "Có lỗi",
                            text: "Vui lòng nhập đủ thông tin",
                            icon: 'warning',
                        });
                        this.$refs["addName"].focus();
                        return false;
                    }
                    _form.append('ID', _that.addRef.ID)
                    _form.append('Title', _that.addRef.Title)
                    _form.append('Link', _that.addRef.Link)
                    _form.append('Target', _that.addRef.Target)
                    _form.append('Name', _that.addRef.Title)
                    _form.append('Description', _that.addRef.Description)
                    _form.append('Range', _that.addRef.Range)
                    _form.append('Image', _that.addRef.Image)
                    _form.append('subjectID', _that.addRef.subjectID)
                    _form.append('gradeID', _that.addRef.gradeID)
                    _form.append('isDownload', _that.addRef.isDownload)
                    _form.append('Tags', _that.addRef.tags)
                    if (_that.addRef.file) {
                        _form.append('fileUpload', this.addRef.file)
                    }
                    //debugger
                    if (_that.addRef.cover) {
                        _form.append('coverImage', this.addRef.cover)
                    }
                    let _url = '@processUrl("Save", "Reference")'
                    axios.post(_url, _form)
                        .then(response => {
                            if (response.Error == null) {
                                Swal.fire(
                                    'Đã cập nhât!',
                                    'Tài liệu đã cập nhật thành công',
                                    'success'
                                )
                                this.loadPreference()
                                this.hideModal()
                            }
                            else {
                                Swal.fire(
                                    'Có lỗi!',
                                    response.Error,
                                    'error'
                                )
                            }

                        }).catch(e => { })
                },
                deleteRef(obj) {
                    Swal.fire({
                        title: 'Chắc chắn xóa?',
                        text: "Bạn sẽ không thể khôi phục lại dữ liệu này sau khi xóa",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        cancelButtonText: 'Hủy',
                        confirmButtonText: 'Đồng ý'
                    }).then((result) => {
                        if (result.value == true) {
                            let _form = new FormData()
                            _form.append('ID', obj.ID)
                            let _url = '@processUrl("Remove", "Reference")'
                            axios.post(_url, _form)
                                .then(response => {
                                    if (response.Error == null) {
                                        Swal.fire(
                                            'Đã xóa!',
                                            'Tài liệu của bạn đã được xóa',
                                            'success'
                                        )
                                        this.loadPreference()
                                    }
                                    else {
                                        Swal.fire(
                                            'Có lỗi!',
                                            response.Error,
                                            'error'
                                        )
                                    }

                                }).catch(e => { })
                        }
                    })
                },
                changeFile() {
                    //debugger
                    var listFiles = $('#modal_event input[type=file]')
                    if (listFiles[1].files[0] != null) { //file dinh kem
                        if (this.typeFile.includes(listFiles[1].files[0]['type'])) {
                            this.addRef.FileName = listFiles[1].files[0].name
                            this.addRef.file = listFiles[1].files[0]
                            this.addRef.isCheckDownload = true;
                        }
                        else {
                            alert("File không đúng định dạng, chọn lại!")
                            this.addRef.isCheckDownload = false;
                            return false;
                        }
                    }
                    if (listFiles[0].files[0] != null) { //anh dai dien
                        this.addRef.coverName = listFiles[0].files[0].name
                        this.addRef.cover = listFiles[0].files[0]
                    }
                },
                showPreview(obj) {
                    let _form = new FormData()
                    _form.append('ID', obj.ID)
                    var link = obj.Media.Path;
                    var title = obj.Title;
                    let _url = '@processUrl("View", "Reference")'
                    axios.post(_url, _form)
                        .then(response => {
                            obj.Viewed = obj.Viewed + 1;
                        }).catch(e => { })
                    let _that = this;
                    _that.linkFile = link;
                    _that.title = title;
                    this.linkFile = _that.linkFile;
                    this.title = _that.title;
                    _that.$bvModal.show('modal_preview')
                },
                isDocType(path) {
                    if (path == null || path == "") return false;
                    var idx = path.toString().lastIndexOf('.');
                    if (idx <= 0) {
                        var ext = path.substring(idx, path.length - idx);
                        return this.allow_doc_ext.findIndex(t => t === ext) >= 0;
                    }
                },
                changeAddSubject(obj) {
                    let _that = this;
                    //debugger
                    if (_that.list_grades_full.findIndex(item => obj == item.ID) == -1) {
                        _that.list_grades_full.forEach(function (sbj) {
                            //console.log(obj.UID)
                            if (sbj.ID == obj.UI) {
                                sbj.GradeID = ''
                                sbj.CourseID = ''
                                sbj.TeacherID = ''
                                sbj.SkillID = ''
                                return
                            }
                        });
                    }
                },
                openLessonResult(obj) {
                    let _that = this;
                    this.hideModal();
                    if (obj != null) {
                        _that.lesson_result.ID = obj.ID
                        _that.lesson_result.Title = obj.Title
                    }
                    this.loadLessonResult(obj.ID);
                    _that.$bvModal.show('modal_lesson_detail')
                },
                loadLessonResult(ID) {
                    let _that = this
                    let _form = new FormData()
                    _form.append('ID', ID)
                    let _url = '@processUrl("GetLessonProgressList", "Exam")'
                    axios.post(_url, _form)
                        .then(response => {
                            var _data = response.data.Data;
                            _that.result_data = [];
                            _data.forEach(function (student, k) {
                                _that.result_data.push(student);
                            });
                            this.result_data = that.result_data;
                            _that.$forceUpdate()
                        }).catch(e => { })
                },
                openHistory(obj) {
                    let _that = this;
                    if (obj != null) {
                        _that.student_result.ID = obj.StudentID
                        _that.student_result.Name = obj.StudentName
                        _that.student_result.History = obj.ListExam
                    }
                    _that.$bvModal.show('modal_history');
                },

                //SUPPORT
                formatShortDate(date) {
                    var _date = moment(date);
                    if (!_date._isValid || _date < moment(new Date(2000, 1, 1))) return "";
                    return _date.format("DD/MM/YYYY")
                },
                formatTime(time) {
                    var _time = moment(time);
                    if (!_time._isValid || _time < moment(new Date(2000, 1, 1))) return "";
                    return _time.format("DD/MM/YYYY HH:mm")
                },
                domDecoder(str) {
                    if (str == null)
                        return "";
                    let parser = new DOMParser();
                    let dom = parser.parseFromString('<!doctype html><body>' + str, 'text/html');
                    return dom.body.textContent;
                },
                replaceBrkLine(str) {
                    if (str == null)
                        return "";
                    return str.replace(/\n/gi, "<br/>")
                },
                getAvgTotal(pos, studentID) {
                    var rs = this.scoreSbjChap[pos].Result;
                    if (rs == null) return -1;
                    var result = rs.filter(t => t.StudentID == studentID);
                    if (result.length == 0)
                        return -1;
                    var exDone = result[0].PracticeDone + result[0].ExamDone;
                    if (exDone == 0)
                        return 0;
                    return ((result[0].PracticePoint + result[0].TotalPoint) / exDone);
                },
                getSbjScoreText(pos, studentID) {
                    var avg = this.getAvgTotal(pos, studentID);
                    if (avg < 0) return "";
                    return avg.toFixed(1);
                },
                shortenString(str, max = 15) {
                    if (str == null || str.length <= max)
                        return "";
                    return str.substring(0, max) + "..."
                },
                hideModal(id) {
                    if (id == null)
                        $('.close').click();
                    else
                        $('#' + id + ' .close').click();
                },
                getPercent(a, b) {
                    var result = 0;
                    if (a > 0)
                        result = a * 100 / b;
                    return result;
                },
                isDocType(path) {
                    if (path == null || path == "") return false;
                    var idx = path.toString().lastIndexOf('.');
                    if (idx <= 0) {
                        var ext = path.substring(idx, path.length - idx);
                        return this.allow_doc_ext.findIndex(t => t === ext) >= 0;
                    }
                },
                showEditor(obj) {
                    window.location.href = '@processUrl("Editor","Class")/' + obj.ID + '/@currentClass.ID';
                },
                showScoreboard(obj) {
                    this.searchCsbj = obj.ID;
                    this.tabChange(2);
                },
                toggleSelect() {
                    this.displaySelect = !this.displaySelect
                },
                checkToggle() {
                    this.filterChap.SelectAll = (this.filterChap.TargetChaps.length == this.scoreSbjChap.length)
                },
                checkToggleAll() {
                    var _that = this
                    _that.filterChap.TargetChaps = []
                    if (_that.filterChap.SelectAll) {
                        _that.scoreSbjChap.forEach(function (item, pos) {
                            _that.filterChap.TargetChaps.push(item.ID)
                        })
                    }
                    _that.checkToggle()
                }
            }
            });

        var loadCheckPointData = function (data, questions) {
            var className = data.ClassName;
            var lessonName = data.LessonName;
            var studentName = data.StudentName;
            var teacherName = data.TeacherName;
            var point = data.Point;
            var questionsDone = data.QuestionsDone;
            var questionsPass = data.QuestionsPass;
            var questionsTotal = data.QuestionsTotal;
            var number = data.Number;
            var modalBody = $('#modal_essay')[0].querySelector('.modal-body');
            modalBody.innerHTML = '<div class="form-group"><label> Bài tự luận của ' + studentName + '</label></div>';
            for (var i = 0; i < data.Parts.length; i++) {
                var part = data.Parts[i];
                if (part.Type == "ESSAY") {
                    var title = part.Title;
                    var des = part.Description;
                    modalBody.innerHTML += '<div class="form-group"><label>Tiêu đề : </label><div>' + title + '</div></div>';
                    modalBody.innerHTML += '<div class="form-group"><label>Nội dung : </label><div>' + des + '</div></div>';
                    var htmlQuestion = '';
                    for (var j = 0; j < part.ExamDetails.length; j++) {
                        var question = part.ExamDetails[j];
                        htmlQuestion += '<div class="item-question">';
                        htmlQuestion += '<div class="form-group"><label>Đáp án : </label><div>' + question.AnswerValue + '</div></div>';
                        htmlQuestion += '<div class="form-group"><label>Điểm : </label><div><input type="number" value="0"/></div></div>';
                        htmlQuestion += '<div class="form-group"><label>Lời giải : </label><quill-editor  ref="quillEditorC" :options="editorOption"></quill-editor></div>';
                        htmlQuestion += '</div>';
                    }
                    modalBody.innerHTML += '<div class="list-question">' + htmlQuestion+'</div>';
                }
            }

        }

        var createInfoParts = function () {

        }

        var toggleTooltips = function(obj)
        {
            console.log($(obj));
            $(obj).find('i').tooltip({
                position: {
                    my: "center bottom-10",
                    at: "center top",
                    using: function (position, feedback) {
                        $(this).css(position);
                        $("<div>")
                            .addClass("arrow")
                            .addClass(feedback.vertical)
                            .addClass(feedback.horizontal)
                            .appendTo(this);
                    }
                },
                show: {
                    delay: 25
                }
            });

        }
    </script>
}
@section Modals{
    <b-modal :no-close-on-backdrop="true" id="modal_event" centered title="Cập nhật tài liệu tham khảo" size="xl">
        <b-col class="form-group">
            <label for="">Tên tài liệu</label>
            <input type="text" name="" value="" class="form-control" placeholder="Tên tài liệu" v-model="addRef.Title">
        </b-col>

        <b-col class="form-group">
            <label for="">Chuyên mục: </label>
            <select class="col-sm-4" v-model="addRef.subjectID">
                <option value="">Chọn chương trình</option>
                <option v-for="(item,k) in list_subject" :value="item.ID" v-if="addRef.subjectID==item.ID">{{item.Name}}</option>
                <option v-for="(item,k) in list_subject" :value="item.ID" v-else>{{item.Name}}</option>
            </select>
            <select class="col-sm-4" v-model="addRef.gradeID">
                <option value="">Cấp độ</option>
                <option v-for="(item,k) in list_grades_full" :value="item.ID" v-if="item.SubjectID==addRef.subjectID">{{item.Name}}</option>
            </select>
        </b-col>

        <b-col class="form-group row">
            <div class="col-sm-4">
                <label for="">Ảnh bìa</label>
                <input type="file" name="CoverImage" id="CoverImage" v-on:change="changeFile()">
            </div>
            <div class="col-sm-8">
                <img :src="addRef.Image" style="max-width:200px;max-height:150px" />
            </div>
        </b-col>
        <b-col class="form-group">
            <label for="">Mô tả</label>
            <quill-editor v-model="addRef.Description"
                          ref="quillEditorA"
                          :options="editorOption">
            </quill-editor>
        </b-col>
        <b-col class="form-group">
            <label for="">Link liên kết</label>
            <input type="text" name="" value="" class="form-control" placeholder="Link liên kết" v-model="addRef.Link">
        </b-col>

        <b-col class="form-group">
            <label class="col-form-label">File đính kèm:</label>
            <i class="ic ic-paper-clip"></i><label class="p-1" ref="filedsp" v-on:click="$refs.file.click()">{{shortenString(addRef.FileName)}} - (Click để chọn)</label>
            <input type="file" ref="file" class="d-none" v-on:change="changeFile()">
        </b-col>
        <b-col class="form-group" v-if="addRef.isCheckDownload">
            <label class="col-form-label">Download:</label>
            <input type="checkbox" name="isDownload" id="isDownload" v-model="addRef.isDownload">
        </b-col>

        <b-col class="form-group">
            <label class="col-form-label">Phạm vi chia sẻ:</label>
            <select name="range" onchange="ChooseRange()" id="refRange" class="form-control d-inline w-25" v-model="addRef.Range">
                <option value="@BaseCustomerEntity.Database.REF_RANGE.ALL">Chung</option>
                <option value="@BaseCustomerEntity.Database.REF_RANGE.TEACHER">Tất cả lớp phụ trách</option>
                <option value="@BaseCustomerEntity.Database.REF_RANGE.CLASS">Riêng trong lớp</option>
            </select>
            <select name="target" id="refTarget" v-model="addRef.Target" class="form-control d-inline w-25" v-if="addRef.Range == '@BaseCustomerEntity.Database.REF_RANGE.CLASS'">
                <option value="@currentClass.ID">@currentClass.Name</option>
            </select>
        </b-col>

        <b-col class="form-group">
            <label for="">Tag</label>
            <input type="text" name="" value="" class="form-control" placeholder="Tag" v-model="addRef.tags">
        </b-col>

        <template v-slot:modal-footer="{ ok, cancel}">
            <template v-if="isLoading">
                <b-button>Đang thực hiện...</b-button>
            </template>
            <template v-else>
                <b-button variant="success" v-on:click="updateRef()">Lưu</b-button>
                <b-button variant="danger" v-on:click="hideModal()">Huỷ</b-button>
            </template>
        </template>
    </b-modal>
    <b-modal :no-close-on-backdrop="true" id="modal_essay" centered title="Check point">
        <b-col class="form-group">
            <label>Bài tự luận của {{checkpoint.StudentName}}</label>
        </b-col>
        <b-col class="list-item" v-for="part in checkpoint.Parts">
            <b-col class="item" v-if="part.Type=='ESSAY'">
                <b-col class="form-group">
                    <label>Tiêu đề : </label>
                    <b-col v-html="part.Title"></b-col>
                    <label>Nội dung :</label>
                    <b-col v-html="part.Description"></b-col>
                </b-col>
                <b-col class="list-question" v-for="question in part.ExamDetails">
                    <b-col class="question">
                        <label>Câu trả lời : </label>
                        <b-col v-html="question.AnswerValue"></b-col>
                    </b-col>
                    <b-col class="answer" :data-id="question.ID">
                        <label>Điểm : <input type="number" v-model="question.Point" /></label>
                        <br />
                        <label>Đáp án :</label>
                        <label>File : </label><input type="file" name="files" :data-target="question.ID" value="" multiple />
                        <quill-editor v-model="question.RealAnswerValue"
                                      ref="quillEditorA"
                                      :options="editorOption">
                        </quill-editor>
                    </b-col>
                </b-col>
            </b-col>
        </b-col>
        <template v-slot:modal-footer="{ ok, cancel}">
            <template v-if="isLoading">
                <b-button>Đang thực hiện...</b-button>
            </template>
            <template v-else>
                <b-button variant="success" onclick="updateCheckPoint()">Lưu</b-button>
                <b-button variant="danger" v-on:click="hideModal()">Huỷ</b-button>
            </template>
        </template>
    </b-modal>

    <b-modal :no-close-on-backdrop="true" id="modal_lesson_detail" size="xl" centered title="Kết quả bài học" style="width:800px">
        <div class="row">
            <div class="col-md-12">
                <div class="flex border-b pb-3 justify-content-between">
                    <div class="flex width-100">
                        <label class="label"><b style="font-size:120%"> {{lesson_result.Title}} </b></label>
                        <input type="hidden" value="{{lesson_result.ID}}" />
                    </div>
                </div>
                <table id="st_table" class="table">
                    <thead>
                        <tr class="text-center">
                            <th rowspan="2" class="align-middle">STT</th>
                            <th rowspan="2" class="align-middle">Tên học viên</th>
                            <th rowspan="2" class="align-middle">Số lượt làm bài</th>
                            <th colspan="3">Điểm </th>
                            <th colspan="3">Lượt làm cuối</th>
                        </tr>
                        <tr class="text-center">
                            <th>Thấp nhất</th>
                            <th>Cao nhất</th>
                            <th>Trung bình</th>
                            <th>Thời gian</th>
                            <th>Trạng thái</th>
                            <th>Điểm</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(item,k) in result_data" v-on:click="openHistory(item)">
                            <td class="text-center">{{k+1}}</td>
                            <td>{{item.StudentName}}</td>
                            <td class="text-center">{{item.TriedCount}}</td>
                            <td class="text-center">{{item.MinPoint.toFixed(2)}}</td>
                            <td class="text-center">{{item.MaxPoint.toFixed(2)}}</td>
                            <td class="text-center">{{item.AvgPoint.toFixed(2)}}</td>
                            <td class="text-center">{{formatTime(item.LastTried)}}</td>
                            <td class="text-center">{{item.IsCompleted ? "Hoàn thành": (item.TriedCount > 0 ? "Chưa hoàn thành": "Chưa làm")}}</td>
                            <td class="text-center">{{item.LastPoint.toFixed(2)}}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <template v-slot:modal-footer>
            <b-button variant="danger" v-on:click="hideModal()">Đóng</b-button>
        </template>
    </b-modal>

    <b-modal :no-close-on-backdrop="true" id="modal_history" size="xl" centered title="Lịch sử làm bài">
        <div class="row">
            <div class="col-md-12">
                <table id="st_table" class="table">
                    <thead>
                        <tr class="text-center">
                            <th class="align-middle">STT</th>
                            <th class="align-middle">Thời gian làm</th>
                            <th>Điểm </th>
                            <th>Trạng thái </th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(item,k) in student_result.History">
                            <td class="text-center">{{k+1}}</td>
                            <td>{{formatTime(item.Created)}}</td>
                            <td class="text-center">{{ (item.MaxPoint > 0 ? item.Point * 100 / item.MaxPoint : 0) .toFixed(2)}}</td>
                            <td class="text-center">{{item.Status ? "Hoàn thành": "Chưa hoàn thành"}}</td>
                            <td class="text-center"><a v-if="item.Status" :href="'@processUrl("CheckPoint","Class")?ID=' + item.ExamID" target="_blank">Xem chi tiết</a></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <template v-slot:modal-footer>
            <b-button variant="danger" v-on:click="hideModal('modal_history')">Đóng</b-button>
        </template>
    </b-modal>

    <b-modal :no-close-on-backdrop="true" id="modal_preview" centered title="Xem tài liệu tham khảo" size="xl">
        <b-col class="form-group">
            <embed class="embed-frame col-sm-12" frameborder="0" :src="linkFile + '#toolbar=0&navpanes=0&scrollbar=0&view=FitH'" v-if="linkFile.toLowerCase().endsWith('.pdf')" style="min-height:500px;"></embed>
            <iframe class="embed-frame col-sm-12" frameborder="0" :src="'https://view.officeapps.live.com/op/embed.aspx?src='+ linkFile" v-else style="min-height:500px;"></iframe>
        </b-col>

        <template v-slot:modal-footer="{ ok, cancel}">
            @*<template v-if="isLoading">
                    <b-button>Đang thực hiện...</b-button>
                </template>*@
            <template>
                <b-button variant="danger" v-on:click="hideModal()">Đóng</b-button>
            </template>
        </template>
    </b-modal>
}
