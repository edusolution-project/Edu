@{
    Layout = "~/Views/Shared/_LayoutStudent_NewUI.cshtml";
    var currentClass = ViewBag.Class as BaseCustomerMVC.Models.ClassViewModel;
    ViewData["Title"] = currentClass.Name;
    string userid = ViewBag.UserID;
    string center = ViewContext.RouteData.Values["basis"]?.ToString();
    string processUrl(string act, string ctrl, Object param = null)
    {
        string url = Url.Action(act, ctrl, param);

        return $"/{center}{url}";
    }
}
<script>
    setActiveMenu("class");
</script>

<section class="module" id="dashboard_content">
    <div class="h4 m-3" v-cloak cloak-holder>
        <i class="fas fa-sync fa-spin"></i> Đang nạp dữ liệu ...
    </div>
    <div class="card-header" v-cloak>
        <div class="flex pb-2">
            <h2 class="title"><a href="@processUrl("Index","Course")" title="Quản lý môn học"><i class="ti-arrow-left d-none"></i></a>{{domDecoder(className)}}</h2>
            <div class="c-right">
                <ul class="time-line flex">
                    <li><i class="ti-time"></i>Bắt đầu: {{formatShortDate(startDate)}} </li>
                    <li><i class="ti-time"></i>Kết thúc: {{formatShortDate(endDate)}} </li>
                </ul>
            </div>
        </div>
        <div class="flex j-between border-b">
            <div class="tab bg-none">
                <ul class="flex flex-row">
                    <li v-bind:class="{active : tab[0]}"><a href="javascript:;" title="Tổng quan" v-on:click="tabChange()">Tổng quan</a></li>
                    <li v-bind:class="{active : tab[1]}"><a href="javascript:;" title="Môn học" v-on:click="tabChange(1)">Môn học</a></li>
                    @*<li v-bind:class="{active : tab[2]}"><a href="javascript:;" title="Tài liệu tham khảo" v-on:click="tabChange(2)">Tài liệu tham khảo</a></li>*@
                    <li v-bind:class="{active : tab[3]}"><a href="javascript:;" title="Trao đổi / thảo luận" v-on:click="tabChange(3)">Thảo luận</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div class="card-body" v-cloak>
        <div class="box" v-if="tab[0]">
            <ul class="box list ls-overview mb-3">
                <li class="flex margin-b20">
                    <a href="#" class="thumb"><img :src="cacheStatic(classImg,256)" alt="" /></a>
                    <div class="c-right">
                        <p><span class="label">Khóa học: </span>{{domDecoder(className)}}</p>
                        <p><span class="label">Chương trình: </span>{{domDecoder(subjectName)}}</p>
                        <p><span class="label">Môn học: </span>{{skillName}}</p>
                        <ul class="time-line flex">
                            <li><i class="ti-time"></i>Bắt đầu: {{formatShortDate(startDate)}} </li>
                            <li><i class="ti-time"></i>Kết thúc: {{formatShortDate(endDate)}} </li>
                        </ul>
                    </div>
                </li>
            </ul>
            <div class="box info-practice">
                <h4>Chi tiết lớp học</h4>
                <p>{{domDecoder(classDescription)}}</p>
            </div>
        </div>
        <div class="form-group">
            <h3 style="font-size:16px;" class="font-weight-bold" v-if="class_mechanism=='@BaseCustomerEntity.Database.CLASS_MECHANISM.PERSONAL'">Học liệu cá nhân</h3>
            <h3 style="font-size:16px;" class="font-weight-bold" v-else>Học liệu chính quy</h3>
            <div class="row row-list" v-if="tab[1]">
                <div class="col-md-3 practice-item" v-for="(item,k) in classSubjects" v-if="item.TypeClass == @BaseCustomerEntity.Database.CLASS_TYPE.STANDARD">
                    <div class="box">
                        <div class="inner text-center">
                            <a :href="'@processUrl("Modules","Course")/' + item.ID" title="" class="title" :style="'color: ' + item.Color">
                                <span class="ic ic-headphone" :style="'background-image:url(' + cacheStatic(item.Image,256) + ');width: 150px; height: 200px;background-size:center; margin-bottom:5px'"></span>
                                @*<div>
                                    <img :src="item.Image" style="max-width:150px; max-height:200px" />
                                </div>*@
                                <div>
                                    {{item.Title}}
                                </div>
                            </a>
                            <span class="name center">
                                {{item.Grade}}<br />
                                GV: {{item.Teacher}}
                            </span>
                            <a :href="'@processUrl("Modules","Course")/' + item.ID" class="btn-learn" :style="'background-color: ' + item.Color">Học ngay</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group">
            <h3 style="font-size:16px;" class="font-weight-bold pt-3" v-if="class_mechanism!='@BaseCustomerEntity.Database.CLASS_MECHANISM.PERSONAL'">Học liệu chuyên đề</h3>
            <div class="row row-list" v-if="tab[1]">
                <div class="col-md-3 practice-item" v-for="(item,k) in classSubjects" v-if="item.TypeClass == @BaseCustomerEntity.Database.CLASS_TYPE.EXTEND">
                    <div class="box">
                        <div class="inner text-center">
                            <a :href="'@processUrl("Modules","Course")/' + item.ID" title="" class="title" :style="'color: ' + item.Color">
                                <span class="ic ic-headphone" :style="'background-image:url(' + cacheStatic(item.Image,256) + ');width: 150px; height: 200px;background-size:center; margin-bottom:5px'"></span>
                                @*<div>
                                    <img :src="item.Image" style="max-width:150px; max-height:200px" />
                                </div>*@
                                <div>
                                    {{item.Title}}
                                </div>
                            </a>
                            <span class="name center">
                                {{item.Grade}}<br />
                                GV: {{item.Teacher}}
                            </span>
                            <a :href="'@processUrl("Modules","Course")/' + item.ID" class="btn-learn" :style="'background-color: ' + item.Color">Học ngay</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="modal_preview" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-lg" style="max-width:90%; width:90%; position: absolute; top: 5%; bottom: 5%; left: 50%; margin-left: -45%;" role="document">
                <div class="modal-content h-100">
                    <div class="modal-header">
                        <h3 class="modal-title">Tài liệu {{title}}</h3>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Đóng">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="container-fluid">
                            <embed class="embed-frame col-sm-12" frameborder="0" :src="linkFile + '#toolbar=0&navpanes=0&scrollbar=0&view=FitH'" v-if="linkFile.toLowerCase().endsWith('.pdf')" style="min-height:500px;"></embed>
                            <iframe class="embed-frame col-sm-12" frameborder="0" :src="'https://view.officeapps.live.com/op/embed.aspx?src='+linkFile" v-else style="min-height:500px;"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="box" v-if="tab[2]">
            <div class="row ls-doc" v-if="ref.data.length > 0">
                <div class="col-md-6" v-for="data in ref.data">
                    <div class="flex p-2 mb-2 inner" style="border-top: dotted 1px #DDD">
                        <a href="#" title="" class="thumb" style="max-width:130px; min-width:130px;">
                            <img :src="cacheStatic(data.Image)" alt="" v-if="data.Image != null" class="w-100">
                            <img src="~/pictures/book.jpg" alt="" v-else class="w-100">
                        </a>
                        <div class="entry p-0">
                            <div>
                                <div>
                                    <a href="#" title="" class="title">{{data.Title}}</a>
                                </div>
                            </div>
                            <div class="pt-0 pb-2">
                                <p>{{(data.Description != 'null') ? domDecoder(data.Description) : ''}}</p>
                            </div>
                            <div>
                                <a href="#" title="Mở link" class="text-success font-weight-bold mr-2" style="min-width:auto" v-on:click="openLink(data)" v-if="data.Link != null && data.Link.length > 0"><i class="fas fa-link"></i> ({{data.Linked}})</a>
                                <a href="#" title="Mở file" class="text-success font-weight-bold mr-2" style="min-width:auto" v-on:click="showPreview(data)" v-if="data.Media!= null && isDocType(data.Media.Extension)"><i class="far fa-eye font-weight-bold"></i> ({{data.Viewed}})</a>
                                <a href="#" class="text-success font-weight-bold mr-2" v-if="data.Media != null && data.isDownload" v-on:click="download(data)" :title="data.Media.Name"><i class="fas fa-cloud-download-alt"></i> ({{data.Downloaded}})</a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="row ls-doc text-center d-block" v-else>
                Không có tài liệu
            </div>
        </div>
        <div class="box margin-t20 flex" v-if="tab[2] && ref.data.length > 0">
            <div class="paging-view">
                Hiển thị:
                <select v-model="ref.view" v-on:change="loadPreference()">
                    <option value="10">10 kết quả</option>
                    <option value="20">20 kết quả</option>
                    <option value="30">30 kết quả</option>
                </select>
            </div>
            <div class="page-control">
                <div class="right">
                    <b-pagination v-model="ref.page"
                                  :total-rows="ref.totalRec"
                                  :per-page="ref.view"
                                  v-on:input="loadPreference()"></b-pagination>
                </div>
            </div>
        </div>
    </div>
</section>
@section Scripts{
    <script>
        new Vue({
            el: "#main_content",
            mounted() {
                this.loadClassDetail()
                window.loadContent = this.loadContent
                var hash = window.location.hash;
                if (hash.startsWith('#')) {
                    hash = hash.split('#')[1]
                    //console.log(hash)
                    switch (hash) {
                        case 'module':
                            this.tabChange(1);
                            break;
                        case 'reference':
                            this.tabChange(2);
                            break;
                        case 'discuss':
                            this.tabChange(3);
                            break;
                        default:
                            this.tabChange(0);
                            break;
                    }
                }
                else {
                    this.tabChange(1);
                }
            },
            data: {
                classID: '@currentClass.ID',
                className: '@currentClass.Name',
                startDate: '@currentClass.StartDate',
                endDate: '@currentClass.EndDate',
                classDescription: '@currentClass.Description',
                classImg: '@currentClass.Image',
                subjectName: '@currentClass.SubjectName',
                skillName: '@currentClass.SkillName',
                classSubjects: [],
                tab: [true, false],
                ref: {
                    range: '@BaseCustomerEntity.Database.REF_RANGE.CLASS',
                    target: '@currentClass.ID',
                    searchTerm: '',
                    data: [],
                    view: 20,
                    page: 1
                },
                linkFile: "",
                allow_doc_ext: [".doc", ".docx", ".xlsx", ".xls", ".ptt", "pttx", ".pdf"],
                title: '',
                class_mechanism:''
            },
            watch: {
            },
            methods: {
                tabChange(a = 0) {
                    // có thể load data theo từng tab để tối ưu hiệu năng
                    // this.getData()
                    let _that = this
                    _that.tab.forEach(function (item, k) {
                        _that.tab[k] = false;
                    })
                    this.tab = _that.tab
                    this.tab[a] = true
                    switch (a) {
                        case 0:
                            history.replaceState({ tab: a }, this.className + " - Tổng quan", "#info");
                            this.loadClassDetail();
                            break;
                        case 1:
                            history.replaceState({ tab: a }, this.className + " - Môn học", "#module");
                            this.loadClassSubjects();
                            break;
                        case 2:
                            history.replaceState({ tab: a }, this.className + " - Tài liệu tham khảo", "#reference");
                            this.loadPreference();
                            break;
                        case 3:
                            this.loadComment();
                            break;
                    }
                    this.$forceUpdate()
                },

                loadClassDetail() {
                    let _that = this
                    let _form = new FormData()
                    _form.append('ID', _that.classID)
                    let _url = '@processUrl("GetDetail", "Course")'
                    axios.post(_url, _form)
                        .then(response => {
                            var _data = response.data.Data;
                        _data.forEach(function (item, k)
                        {
                            _that.teacherSource.push({
                                ID: item.id,
                                FullName: item.fullname,
                                SubjectID: obj.SubjectID
                            })
                        })
                            //debugger
                        _that.loaded_teacher.push(obj.SubjectID);
                    }).catch(e => { })
                },
                loadComment() {
                    //document.location = '#comment'
                    $('.fn-box-chat-eduso').focus().click()
                },

                //MODULES
                loadClassSubjects() {
                    let _that = this
                    if (_that.classSubjects.length > 0)
                        return;

                    let _form = new FormData()
                    _form.append('ClassID', _that.classID)
                    let _url = '@processUrl("GetClassSubjects", "ClassSubject")'
                        axios.post(_url, _form)
                            .then(response => {
                                var _data = response.data.Data;
                                _that.class_mechanism = response.data.ClassMechanism;
                                //debugger
                                _that.classSubjects = [];
                                _data.forEach(function (item, k) {
                                    _that.classSubjects.push({
                                        ID: item.ID,
                                        Title: item.SkillName,
                                        Image: item.SkillImage,
                                        Color: item.Color,
                                        Teacher: item.TeacherName,
                                        Grade: item.GradeName,
                                        Chapters: [],
                                        Lessons: [],
                                        TypeClass:item.TypeClass
                                    })
                                    //_that.changeAddSubject(item)
                                    //_that.changeAddGrade(item)
                                })

                                //_that.$forceUpdate()
                            }).catch(e => { })
                },
                matchedItem(obj, key) {
                    return (obj.ClassSubject + '-' + obj.Parent) == key
                },
                filterItem(obj, list) {
                    return list.filter((p) => {
        	            return p.Parent == obj.ID && p.ClassSubject == obj.ClassSubject
                    })
                },


                //REF
                loadPreference() {
                    let _that = this
                    let _form = new FormData()
                    _form.append('SearchText', "")
                    _form.append('Target', _that.ref.target)
                    _form.append('PageSize', _that.ref.view)
                    _form.append('PageIndex', _that.ref.page)

                    let _url = '@processUrl("GetClassList", "Reference")'

                    axios.post(_url, _form)
                        .then(response => {
                            _that.ref.data = response.data.Data;
                            this.ref.data = _that.ref.data
                            this.ref.totalRec = response.data.Model.totalRecord
                            console.log(totalRec)
                            //var tt = response.data.Model.totalRecord;
                            //this.max_page = tt / this.view + (tt % this.view > 0 ? 1 : 0);
                            //console.log(_that.active_course);
                        }).catch(e => { })
                },
                openLink(obj) {
                    obj.Viewed = obj.Viewed + 1;
                    window.open('@processUrl("OpenLink", "Reference")/' + obj.ID);
                },
                download(obj) {
                    if (obj.Media == null)
                        return false;
                    obj.Downloaded = obj.Downloaded + 1;
                    window.open('@processUrl("Download", "Reference")/' + obj.ID);
                },
                showPreview(obj) {
                    let _form = new FormData()
                    _form.append('ID', obj.ID)
                    var link = obj.Media.Path;
                    var title = obj.Title;
                    let _url = '@processUrl("View", "Reference")'
                    axios.post(_url, _form)
                        .then(response => {
                            obj.Viewed = obj.Viewed + 1;
                        }).catch(e => { })
                    let _that = this;
                    console.log(obj);
                    if (!link.startsWith("http"))
                        link = "https://eduso.vn" + link;
                    _that.linkFile = link;
                    _that.title = title;
                    this.linkFile = _that.linkFile;
                    this.title = _that.title;
                    $("#modal_preview").modal();
                },

                //SUPPORT
                domDecoder(str) {
                    if (str == null || str == 'null')
                        return "";
                    //console.log(str);
                    let parser = new DOMParser();
                    let dom = parser.parseFromString('<!doctype html><body>' + str, 'text/html');
                    return dom.body.textContent;
                },
                cacheStatic(src, width) {
                    if (src.startsWith("http"))
                        return src;
                    return "https://static.eduso.vn/" + src + "?w=" + width;
                },
                formatShortDate(date) {
                    if (moment(date) < moment(new Date(2000, 1, 1))) return "-"
                    return moment(date).format("DD/MM/YYYY")
                },
                isDocType(path) {
                    if (path == null || path == "") return false;
                    var idx = path.toString().lastIndexOf('.');
                    if (idx <= 0) {
                        var ext = path.substring(idx, path.length - idx);
                        return this.allow_doc_ext.findIndex(t => t === ext) >= 0;
                    }
                }

            }
        });
    </script>
}

